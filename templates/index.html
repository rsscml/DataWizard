<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Analytics Platform - AI-Powered Data Analysis</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f2ff 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #73706E;
        }
        
        .main-container {
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f2ff 25%, #ffffff 50%, #f8f9fa 75%, #e8f2ff 100%);
            color: #73706E;
            height: 100vh;
            overflow: hidden;
            padding: 15px;
            border-right: 3px solid #005EEF;
            box-shadow: 2px 0 15px rgba(31, 54, 199, 0.08);
            transition: margin-left 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar.collapsed {
            width: 0 !important;
            min-width: 0 !important;
            overflow: hidden;
            padding: 0 !important;
            border: none !important;
            transition: width 0.3s ease, padding 0.3s ease;
        }

        .logo-container {
            position: fixed;
            bottom: 5px;
            right: 25px;
            z-index: 10002;
        }

        /* Mode Toggle Button for Database Mode */
        .mode-toggle-container {
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .mode-toggle-btn {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(31, 54, 199, 0.2);
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .mode-toggle-btn:hover {
            background: linear-gradient(135deg, #0d2499 0%, #0048c7 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(31, 54, 199, 0.3);
        }

        /* Outputs Manager Sidebar */
        .outputs-sidebar {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #73706E;
            height: 100vh;
            overflow: hidden;
            padding: 15px;
            border-left: 3px solid #005EEF;
            box-shadow: -2px 0 15px rgba(31, 54, 199, 0.08);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            position: fixed;
            right: 0;
            top: 0;
            width: 350px;
            z-index: 2000;
            transform: translateX(100%);
        }
        
        .outputs-sidebar.open {
            transform: translateX(0);
            box-shadow: -20px 0 50px rgba(31, 54, 199, 0.2);
        }

        /* Overlay when outputs sidebar is open */
        .outputs-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(115, 112, 110, 0.3);
            z-index: 1400; /* Lower than output cards (1500) */
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none; /* Let clicks pass through when hidden */
        }

        .outputs-overlay.active {
            opacity: 1;
            visibility: visible;
            pointer-events: all; /* Enable clicks when active */
        }
        
        .outputs-header {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(31, 54, 199, 0.15);
            margin-bottom: 15px;
        }
        
        .outputs-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .output-summary {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #005EEF;
            box-shadow: 0 2px 8px rgba(0, 94, 239, 0.06);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .output-summary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 94, 239, 0.12);
        }
        
        .output-summary.active {
            border-left-color: #1F36C7;
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f2ff 100%);
        }
        
        .output-summary-title {
            font-weight: bold;
            font-size: 13px;
            color: #73706E;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .output-summary-time {
            font-size: 11px;
            color: #73706E;
            margin-bottom: 5px;
            opacity: 0.7;
        }
        
        .output-summary-type {
            font-size: 10px;
            padding: 2px 8px;
            background: #005EEF;
            color: white;
            border-radius: 12px;
            display: inline-block;
        }

        /* Pulse animation for outputs toggle when sidebar is closed but has content */
        .outputs-toggle.has-hidden-outputs {
            animation: pulse-blue 2s infinite;
        }

        @keyframes pulse-blue {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 94, 239, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(0, 94, 239, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 94, 239, 0);
            }
        }
        
        .content-area {
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 0;
            transition: margin-left 0.3s ease, margin-right 0.3s ease;
        }
        
        .content-area.expanded {
            margin-left: -25%;
        }
        
        .file-upload-area {
            border: 3px dashed #005EEF;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            margin: 20px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #f0f4ff 100%);
            transition: all 0.3s ease;
            cursor: pointer;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(31, 54, 199, 0.08);
        }
        
        .file-upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(31, 54, 199, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(0, 94, 239, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .file-upload-area:hover {
            border-color: #1F36C7;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 50%, #d1e7ff 100%);
            transform: scale(1.02);
            box-shadow: 0 12px 30px rgba(31, 54, 199, 0.12);
        }
        
        .file-upload-area.dragover {
            border-color: #1F36C7;
            background: linear-gradient(135deg, #fff5f8 0%, #ffe6f2 50%, #ffd6e6 100%);
            transform: scale(1.03);
            box-shadow: 0 15px 35px rgba(31, 54, 199, 0.15);
        }
        
        .upload-content {
            position: relative;
            z-index: 1;
            max-width: 600px;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #005EEF;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .file-upload-area:hover .upload-icon {
            color: #1F36C7;
            transform: translateY(-5px) scale(1.1);
            opacity: 1;
        }
        
        .upload-title {
            font-size: 2rem;
            font-weight: bold;
            color: #73706E;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .upload-subtitle {
            font-size: 1.1rem;
            color: #73706E;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .upload-button {
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 6px 20px rgba(31, 54, 199, 0.12);
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            margin-bottom: 20px;
            font-family: Arial, sans-serif;
        }
        
        .upload-button:hover {
            background: linear-gradient(135deg, #0d2499 0%, #0048c7 100%);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(31, 54, 199, 0.2);
        }
        
        .upload-info {
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            box-shadow: 0 6px 20px rgba(31, 54, 199, 0.08);
            border: 1px solid rgba(0, 94, 239, 0.2);
        }
        
        .upload-info h5 {
            color: #73706E;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .upload-info p {
            color: #73706E;
            margin: 8px 0;
            line-height: 1.5;
        }
        
        /* Enhanced Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #005EEF;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(31, 54, 199, 0.1);
            margin-top: 15px;
            min-height: 0;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 15px 15px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(31, 54, 199, 0.15);
            flex-shrink: 0;
        }

        .chat-header-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .sidebar.collapsed {
            flex: 0 0 0 !important;
            width: 0 !important;
            min-width: 0 !important;
            max-width: 0 !important;
            overflow: hidden;
            padding: 0 !important;
            border: none !important;
            transition: all 0.3s ease;
        }

        /* Override Bootstrap grid when sidebar is collapsed */
        .content-area.sidebar-collapsed {
            flex: 1 !important;
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 15px !important;
            transition: all 0.3s ease;
        }

        /* Force the main row to use flexbox */
        .main-container .row {
            display: flex !important;
            transition: all 0.3s ease;
            margin: 0 !important;
            width: 100% !important;
        }

        /* Ensure normal state works too */
        .sidebar:not(.collapsed) {
            flex: 0 0 25% !important;
            width: 25% !important;
            transition: all 0.3s ease;
        }

        .content-area:not(.sidebar-collapsed) {
            flex: 0 0 75% !important;
            width: 75% !important;
            transition: all 0.3s ease;
        }
        
        /* Ensure proper transitions for all screen sizes */
        @media (min-width: 769px) {
            .sidebar {
                transition: margin-left 0.3s ease;
            }

            .content-area {
                transition: margin-left 0.3s ease;
            }
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            min-height: 0;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #005EEF;
            border-radius: 0 0 15px 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            flex-shrink: 0;
        }

        .chat-input-container {
            position: relative;
            display: flex;
            align-items: flex-end;
        }

        .chat-input-container textarea {
            resize: vertical;
            min-height: 70px;
            max-height: 120px;
            line-height: 1.4;
            padding-right: 45px !important; /* Make room for send button */
            border-radius: 20px;
            border: 2px solid #005EEF;
        }

        .chat-input-container textarea:focus {
            outline: none;
            border-color: #1F36C7;
            box-shadow: 0 0 0 3px rgba(31, 54, 199, 0.1);
        }

        .chat-send-btn {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: none;
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            box-shadow: 0 2px 8px rgba(31, 54, 199, 0.2);
            transition: all 0.2s ease;
            z-index: 10;
        }

        .chat-send-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #0d2499 0%, #0048c7 100%);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(31, 54, 199, 0.3);
        }

        .chat-send-btn:disabled {
            background: #73706E;
            transform: none;
            box-shadow: 0 2px 4px rgba(115, 112, 110, 0.2);
        }

        .chat-send-btn i {
            margin-left: 1px; /* Slight offset to center the paper plane icon */
        }
        .message {
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(31, 54, 199, 0.06);
        }
        
        .user-message {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            text-align: right;
            margin-left: 15%;
        }
        
        .ai-message {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            color: #73706E;
            margin-right: 15%;
            border: 1px solid #005EEF;
        }
        
        .system-message {
            background: linear-gradient(135deg, #FFC000 0%, #ff9800 100%);
            color: white;
            text-align: center;
            font-style: italic;
            margin: 5px 0;
        }
        
        /* Enhanced Output Cards */
        .output-card {
            position: fixed;
            background: white;
            border-radius: 15px;
            box-shadow: 0 12px 40px rgba(31, 54, 199, 0.18);
            z-index: 1500;
            min-width: 400px;
            max-width: none;
            min-height: 300px;
            max-height: none;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            pointer-events: all; /* Ensure cards can be clicked */
        }
        
        .output-card.active {
            border-color: #005EEF;
            box-shadow: 0 15px 50px rgba(0, 94, 239, 0.25);
        }
        
        .output-card.minimized {
            height: 60px !important;
            min-height: 60px !important;
            width: 300px !important;
        }
        
        .output-card.minimized .output-card-content {
            display: none;
        }
        
        .output-card-header {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            cursor: move;
            font-size: 14px;
        }
        
        .output-card-title {
            flex: 1;
            margin-right: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-decoration: ellipsis;
        }
        
        .output-card-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .output-card-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            min-width: 30px;
        }
        
        .output-card-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .output-card-btn.danger {
            background: rgba(255, 84, 79, 0.8);
        }
        
        .output-card-btn.danger:hover {
            background: rgba(255, 84, 79, 0.9);
        }
        
        .output-card-content {
            padding: 20px;
            overflow: auto;
            height: calc(100% - 60px);
            background: white;
        }
        
        /* Enhanced table styles with pagination info */
        .table-container {
            position: relative;
            margin: 10px 0;
        }
        
        .table-info {
            background: linear-gradient(135deg, #e8f2ff 0%, #f0f4ff 100%);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            color: #73706E;
            margin-bottom: 10px;
            border-left: 4px solid #005EEF;
        }
        
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pagination-btn {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #0d2499 0%, #0048c7 100%);
            transform: translateY(-1px);
        }
        
        .pagination-btn:disabled {
            background: #73706E;
            cursor: not-allowed;
            transform: none;
        }
        
        .pagination-info {
            font-size: 12px;
            color: #73706E;
        }
        
        .rows-per-page {
            padding: 5px 8px;
            border: 1px solid #005EEF;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .output-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 14px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(31, 54, 199, 0.08);
        }
        
        .output-table th {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            padding: 12px;
            border: none;
            font-weight: bold;
            text-align: left;
        }
        
        .output-table td {
            padding: 10px 12px;
            border: 1px solid #e8f2ff;
            background: white;
            color: #73706E;
        }
        
        .output-table tr:nth-child(even) td {
            background: #f8f9fa;
        }
        
        .output-table tr:hover td {
            background: #e8f2ff;
        }
        
        .output-single-value {
            font-size: 18px;
            font-weight: bold;
            color: #73706E;
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f2ff 100%);
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(31, 54, 199, 0.08);
        }
        
        .output-code-block {
            background: linear-gradient(135deg, #73706E 0%, #5a5855 100%);
            color: #ecf0f1;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            margin: 15px 0;
            font-size: 13px;
            overflow-x: auto;
            box-shadow: 0 4px 12px rgba(115, 112, 110, 0.15);
        }

        /* Toggleable Code Section */
        .code-section {
            margin-top: 15px;
            border-top: 1px solid #005EEF;
            padding-top: 15px;
        }

        .code-toggle-btn {
            background: linear-gradient(135deg, #73706E 0%, #5a5855 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .code-toggle-btn:hover {
            background: linear-gradient(135deg, #5a5855 0%, #4a4845 100%);
            transform: translateY(-1px);
        }

        .code-toggle-btn i {
            transition: transform 0.3s ease;
        }

        .code-toggle-btn.expanded i {
            transform: rotate(90deg);
        }

        .code-content {
            margin-top: 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .code-content.show {
            max-height: 500px;
            overflow-y: auto;
            opacity: 1;
        }
        
        /* Ensure embedded chart takes full space */
        .embedded-chart {
            margin: 10px 0;
            border: 1px solid #005EEF;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(31, 54, 199, 0.08);
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 650px; /* Increased minimum height */
        }

        .chart-header {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 14px;
            flex: 0 0 auto;
        }

        /* Force chart containers to exact dimensions */
        .chart-content {
            background: white;
            padding: 5px;
            min-height: 600px;
            flex: 1;
            overflow: hidden;
        }

        .chart-content > div {
            width: 100% !important;
            height: 100% !important;
            flex: 1 !important;
            min-height: 330px !important;
        }

        /* Copy Menu */
        .copy-menu {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(31, 54, 199, 0.15);
            padding: 8px 0;
            z-index: 2000;
            min-width: 150px;
            border: 1px solid #005EEF;
        }
        
        .copy-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 13px;
            color: #73706E;
            transition: all 0.2s ease;
        }
        
        .copy-menu-item:hover {
            background: #e8f2ff;
            color: #005EEF;
        }
        
        .copy-menu-item i {
            margin-right: 8px;
            width: 15px;
        }
        
        /* FIXED: Full-screen spreadsheet styles */
        .spreadsheet-container {
            flex: 1;
            overflow: hidden;
            background: white;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .spreadsheet-container.normal-mode {
            margin: 10px;
            border: 2px solid #005EEF;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(31, 54, 199, 0.08);
        }
        
        .spreadsheet-header {
            background: linear-gradient(135deg, #73706E 0%, #5a5855 100%);
            color: white;
            padding: 12px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(115, 112, 110, 0.15);
            z-index: 1000;
            position: relative;
            flex-shrink: 0;
        }
        
        .spreadsheet-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .view-mode-toggle, .outputs-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .view-mode-toggle:hover, .outputs-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        /* FIXED: OnlyOffice editor container - this is the key fix */
        .onlyoffice-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #onlyoffice-editor {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            flex: 1;
        }

        /* Force OnlyOffice to fill expanded space */
        .content-area.sidebar-collapsed .spreadsheet-container {
            width: 100% !important;
            max-width: 100% !important;
        }

        .content-area.sidebar-collapsed .onlyoffice-container {
            width: 100% !important;
            max-width: 100% !important;
            height: 100% !important;
        }

        .content-area.sidebar-collapsed #onlyoffice-editor {
            width: 100% !important;
            max-width: 100% !important;
            height: 100% !important;
        }

        /* Force OnlyOffice to recalculate on sidebar state changes */
        .sidebar-collapsed .spreadsheet-container.normal-mode {
            margin: 10px !important;
            width: calc(100% - 20px) !important;
        }

        .editor-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 1001;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(31, 54, 199, 0.15);
        }
        
        /* Fullscreen mode styles */
        .fullscreen-mode {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            margin: 0 !important;
            border: none !important;
            border-radius: 0 !important;
        }

        .fullscreen-mode .onlyoffice-container {
            width: 100% !important;
            height: 100% !important;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            transition: all 0.3s ease;
            font-family: Arial, sans-serif;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0d2499 0%, #0048c7 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(31, 54, 199, 0.15);
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 8px rgba(0,0,0,0.2);
        }
        
        .status-connected {
            background: linear-gradient(135deg, #00B190 0%, #00d4aa 100%);
            box-shadow: 0 0 12px rgba(0, 177, 144, 0.4);
        }
        
        .status-disconnected {
            background: linear-gradient(135deg, #FF544F 0%, #ff3c36 100%);
            box-shadow: 0 0 12px rgba(255, 84, 79, 0.4);
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #005EEF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .file-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border: 1px solid #00B190;
            border-radius: 10px;
            padding: 12px 15px;
            margin: 10px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0, 177, 144, 0.08);
            flex-shrink: 0;
            color: #73706E;
        }
              
        .file-info.csv-combined {
            background: linear-gradient(135deg, #e8f2ff 0%, #d1e7ff 100%);
            border: 1px solid #005EEF;
        }
        
        #fileInput {
            display: none;
        }
        
        .chart-overlay {
            position: fixed;
            background: white;
            border: 2px solid #005EEF;
            border-radius: 15px;
            padding: 0;
            box-shadow: 0 12px 40px rgba(31, 54, 199, 0.2);
            z-index: 1600;
            min-width: 400px;
            min-height: 300px;
            cursor: move;
            overflow: hidden;
        }
        
        .chart-overlay .chart-header {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            padding: 12px 20px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .charts-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1600;
        }
        
        .charts-container .chart-overlay {
            pointer-events: all;
        }
        
        /* Sidebar toggle button */
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 10px;
            z-index: 10000;
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            box-shadow: 0 6px 15px rgba(31, 54, 199, 0.2);
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
            transform: translateX(-20px);
        }

        .sidebar-toggle.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .sidebar-toggle:hover {
            background: linear-gradient(135deg, #0d2499 0%, #0048c7 100%);
            transform: scale(1.1);
        }

        /* Copy notification */
        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00B190 0%, #00d4aa 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            z-index: 10001;
            font-weight: bold;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 177, 144, 0.15);
        }
        
        .copy-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 9998;
                width: 280px;
                margin-left: -280px;
                transition: margin-left 0.3s ease;
            }
            
            .sidebar.show {
                margin-left: 0;
            }
            
            .outputs-sidebar {
                width: 300px;
            }
            
            .content-area {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            .output-card {
                width: 95vw !important;
                max-width: 95vw !important;
                left: 2.5vw !important;
            }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0d2499 0%, #0048c7 100%);
        }

        /* Template UI Enhancements */
        .template-suggestions {
            animation: slideInTemplate 0.3s ease;
        }

        @keyframes slideInTemplate {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .template-info-container {
            animation: slideInTemplate 0.3s ease;
        }

        .template-indicator {
            position: relative;
        }

        .template-indicator::after {
            content: '🎯';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 12px;
        }

        /* Enhanced chat message for template queries */
        .template-enhanced-message {
            border-left: 4px solid #00B190 !important;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%) !important;
        }

        /* Template modal improvements */
        .modal-xl {
            max-width: 95%;
        }

        .template-card {
            transition: all 0.2s ease;
        }

        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Template suggestion badge */
        .template-suggestion-badge {
            background: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        /* Template active indicator */
        .template-active-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 10px;
            height: 10px;
            background: #00B190;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 177, 144, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(0, 177, 144, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 177, 144, 0);
            }
        }

        /* Resize handle for output cards */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            clip-path: polygon(100% 0%, 0% 100%, 100% 100%);
            z-index: 10; /* Ensure it's above other elements */
        }

        .resize-handle:hover {
            background: linear-gradient(135deg, #0d2499 0%, #0048c7 100%);
        }

        /* only disable text selection during resize */
        .output-card.resizing {
            user-select: none;
        }

        .output-card.resizing .output-card-header {
            pointer-events: none; /* Only disable header dragging during resize */
        }
        
        /* Auto-positioning animation */
        @keyframes slideInCard {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .output-card.new {
            animation: slideInCard 0.3s ease;
        }
        
        /* Enhanced combined output layout */
        .combined-output {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 10px;
        }

        .chart-priority {
            flex: 1; /* Chart takes most available space */
            min-height: 300px;
        }

        .chart-focused {
            padding: 5px !important; /* Reduce padding for more chart space */
        }

        .data-section {
            flex: 0 0 auto; /* Data section takes only what it needs */
            max-height: 200px; /* Limit data section height */
        }

        .data-section.collapsed {
            flex: 0 0 40px; /* Just header height when collapsed */
        }

        .output-section-header.clickable {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .output-section-header.clickable:hover {
            background: linear-gradient(135deg, #e8f2ff 0%, #f0f4ff 100%);
        }

        .data-content {
            max-height: 150px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        /* Ensure embedded chart uses full height in combined output */
        .chart-focused .embedded-chart {
             margin: 0;
            flex: 1;
            height: 100%;
            min-height: unset;
            border-radius: 0;
        }

        .chart-focused .chart-content {
            padding: 5px;
            flex: 1;
            height: 100%;
            min-height: unset;
        }

        .chart-focused .chart-content > div {
            width: 100% !important;
            height: 100% !important;
        }

        /* Ensure the chart header doesn't take too much space */
        .chart-focused .chart-header {
            flex: 0 0 auto; /* Don't grow, fixed size */
            padding: 8px 15px; /* Reduce padding */
        }

        .output-section {
            border: 1px solid #005EEF;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(31, 54, 199, 0.05);
        }
        
        .output-section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f2ff 100%);
            padding: 10px 15px;
            font-weight: bold;
            color: #73706E;
            border-bottom: 1px solid #005EEF;
        }
        
        .output-section-content {
            padding: 15px;
            background: white;
        }

        /* Insights section styles */
        .insights-section {
            animation: slideInInsights 0.3s ease;
        }

        @keyframes slideInInsights {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .insights-header {
            box-shadow: 0 2px 8px rgba(0, 94, 239, 0.08);
        }

        .commentary-section {
            box-shadow: 0 2px 8px rgba(0, 94, 239, 0.05);
            transition: all 0.2s ease;
        }

        .commentary-section:hover {
            box-shadow: 0 4px 12px rgba(0, 94, 239, 0.1);
        }

        .insights-list {
            box-shadow: 0 2px 8px rgba(255, 105, 180, 0.08);
            transition: all 0.2s ease;
        }

        .insights-list:hover {
            box-shadow: 0 4px 12px rgba(255, 105, 180, 0.12);
        }

        .insights-list ul li {
            position: relative;
        }

        .insights-list ul li::marker {
            color: #FF69B4;
            font-weight: bold;
        }

        /* Responsive adjustments for insights */
        @media (max-width: 768px) {
            .insights-section {
                margin-top: 15px;
                padding-top: 12px;
            }

            .insights-header {
                padding: 10px 12px;
                font-size: 13px;
            }

            .commentary-section {
                padding: 10px 12px;
                font-size: 13px;
            }

            .insights-list {
                padding: 12px;
            }
        }

        /* Brand icon color */
        h4 i {
            color: #005EEF !important;
        }

        /* Button styles consistency */
        .btn-outline-light {
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .btn-outline-light:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-outline-danger {
            border-color: #FF544F;
            color: #FF544F;
        }
        
        .btn-outline-danger:hover {
            background: #FF544F;
            color: white;
        }

        /* View Toggle Styles */
        .view-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .view-toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .view-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #005EEF;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .view-label {
            font-size: 12px;
            color: white;
            font-weight: bold;
        }

        /* Outputs View Container */
        .outputs-view-container {
            flex: 1;
            overflow: hidden;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(31, 54, 199, 0.1);
            margin: 10px;
            display: none;
            flex-direction: column;
        }

        .outputs-view-container.active {
            display: flex;
        }

        .outputs-view-header {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 15px 15px 0 0;
            flex-shrink: 0;
        }

        .outputs-view-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .outputs-view-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #73706E;
            text-align: center;
        }

        .outputs-view-empty i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Stacked Output Cards */
        .stacked-output-card {
            background: white;
            border: 2px solid #005EEF;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(31, 54, 199, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stacked-output-card:hover {
            box-shadow: 0 12px 35px rgba(31, 54, 199, 0.15);
            transform: translateY(-2px);
        }

        .stacked-output-card:last-child {
            margin-bottom: 0;
        }

        .stacked-output-header {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stacked-output-content {
            padding: 20px;
            max-height: none;
            overflow: visible;
        }

        .stacked-output-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .stacked-output-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .stacked-output-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .stacked-output-btn.danger {
            background: rgba(255, 84, 79, 0.8);
        }

        .stacked-output-btn.danger:hover {
            background: rgba(255, 84, 79, 0.9);
        }

        /* Hide floating output cards when in outputs view */
        .content-area.outputs-view-active .output-card {
            display: none !important;
        }

        /* Ensure stacked charts have proper dimensions */
        .stacked-output-content .embedded-chart {
            min-height: 400px;
        }

        .stacked-output-content .chart-content {
            min-height: 350px;
        }

        /* Hide floating output cards when in outputs view - make this more specific */
        .outputs-view-active .output-card {
            display: none !important;
        }

        /* Ensure floating cards are visible in spreadsheet view */
        .content-area:not(.outputs-view-active) .output-card {
            display: block !important;
        }

        /* Additional specificity for charts container */
        .outputs-view-active .charts-container .output-card {
            display: none !important;
        }

        /* Hide the charts container entirely when in outputs view */
        .outputs-view-active .charts-container {
            display: none !important;
        }

        /* Enhanced spreadsheet header layout */
        .spreadsheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(135deg, #73706E 0%, #5a5855 100%);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(115, 112, 110, 0.15);
            z-index: 1000;
            position: relative;
            flex-shrink: 0;
        }

        .spreadsheet-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .spreadsheet-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }

        /* Compact file info display */
        .compact-file-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            opacity: 0.9;
        }

        .file-name-display {
            font-weight: bold;
        }

        .file-stats {
            opacity: 0.8;
        }

        /* Template suggestions button in header */
        .template-suggestions-btn {
            background: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            animation: pulse-pink 2s infinite;
        }

        .template-suggestions-btn:hover {
            background: linear-gradient(135deg, #FF1493 0%, #DC143C 100%);
            transform: translateY(-1px);
        }

        .suggestions-count {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
        }

        @keyframes pulse-pink {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 105, 180, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 105, 180, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 105, 180, 0);
            }
        }

        /* Hide the old bars - we'll hide these with JS when data is loaded */
        .file-info.header-integrated {
            display: none !important;
        }

        .template-suggestions.header-integrated {
            display: none !important;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .spreadsheet-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .spreadsheet-header-left {
                justify-content: center;
            }

            .spreadsheet-controls {
                justify-content: center;
                flex-wrap: wrap;
            }

            .compact-file-info {
                justify-content: center;
            }
        }

        /* Nested Dictionary Styles */
        .nested-dictionary {
            margin: 10px 0;
        }

        .dictionary-section {
            border: 1px solid #e8f2ff;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .dictionary-section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f2ff 100%);
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #e8f2ff;
            user-select: none;
        }

        .dictionary-section-header:hover {
            background: linear-gradient(135deg, #e8f2ff 0%, #d1e7ff 100%);
        }

        .dictionary-section-content {
            padding: 15px;
            background: white;
        }

        .dictionary-simple-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .dictionary-simple-item:last-child {
            border-bottom: none;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            color: #005EEF;
            width: 12px;
        }

        .nested-table {
            margin: 5px 0;
            font-size: 13px;
        }

        .nested-table th,
        .nested-table td {
            padding: 8px 10px;
        }

        /* Value type styles */
        .simple-value {
            color: #73706E;
        }

        .null-value {
            color: #999;
            font-style: italic;
        }

        .empty-array {
            color: #999;
            font-style: italic;
        }

        .inline-array {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        .unknown-value {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            color: #856404;
        }

        /* Type badges */
        .value-type-badge {
            margin-left: auto;
        }

        .type-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .type-badge.array {
            background: #e3f2fd;
            color: #1976d2;
        }

        .type-badge.object {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .type-badge.primitive {
            background: #e8f5e8;
            color: #388e3c;
        }

        /* Combined Output Toggle Styles */
        .combined-output {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .combined-output-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f2ff 100%);
            padding: 10px 15px;
            border-bottom: 2px solid #005EEF;
            border-radius: 8px 8px 0 0;
            flex-shrink: 0;
        }

        .output-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: bold;
            color: #73706E;
            transition: all 0.3s ease;
            opacity: 0.6;
        }

        .toggle-label.active {
            color: #005EEF;
            opacity: 1;
        }

        .output-toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .output-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .output-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #005EEF;
            transition: .4s;
            border-radius: 24px;
        }

        .output-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .output-slider {
            background-color: #FF69B4;
        }

        input:checked + .output-slider:before {
            transform: translateX(26px);
        }

        /* Combined sections */
        .combined-section {
            flex: 1;
            overflow: hidden;
            display: none;
        }

        .combined-section.active {
            display: flex;
            flex-direction: column;
        }

        .combined-section.chart-section {
            padding: 0;
        }

        .combined-section.data-section {
            padding: 15px;
            overflow-y: auto;
        }

        .full-data-content {
            height: 100%;
            overflow-y: auto;
        }

        /* Ensure chart takes full available space when active */
        .combined-section.chart-section.active .embedded-chart {
            flex: 1;
            height: 100%;
            margin: 0;
        }

        .combined-section.chart-section.active .chart-content {
            flex: 1;
            height: 100%;
            min-height: unset;
        }

        /* Make data section scrollable when active */
        .combined-section.data-section.active {
            overflow-y: auto;
            max-height: none;
        }

        /* Improve nested dictionary display in full data view */
        .full-data-content .nested-dictionary {
            margin: 0;
        }

        .full-data-content .dictionary-section {
            margin-bottom: 15px;
        }

        /* Remove the old combined output constraints */
        .combined-output .chart-priority,
        .combined-output .data-section.collapsed,
        .combined-output .data-content {
            /* Remove these old rules or set them to auto */
            max-height: none;
            flex: unset;
        }
        
        /* Data section header styles */
        .data-section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e8f2ff 100%);
            padding: 10px 15px;
            border-bottom: 1px solid #005EEF;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #73706E;
            border-radius: 8px 8px 0 0;
            margin: -15px -15px 15px -15px; /* Counteract parent padding */
        }

        .data-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .data-section-controls {
            display: flex;
            gap: 8px;
        }

        .data-copy-btn {
            background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .data-copy-btn:hover {
            background: linear-gradient(135deg, #0d2499 0%, #0048c7 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(31, 54, 199, 0.2);
        }

        /* Adjust data content padding */
        .combined-section.data-section .full-data-content {
            padding-top: 0; /* Remove top padding since header provides spacing */
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="/static/images/PerfCockpit.svg" style="width: 8em; height: 8em;" alt="Logo">
    </div>
    <div class="container-fluid main-container">
        <div class="row h-100">
            <!-- Left Sidebar - AI Assistant -->
            <div class="col-md-3 sidebar" id="sidebar">
                <div style="flex-shrink: 0; margin-bottom: 10px;">
                    <h3 style="background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: bold; margin-bottom: 5px; font-size: 1.75rem;">
                        <i class="fas fa-database" style="color: #005EEF;"></i> Data Wizard
                    </h3>
                    <p style="color: #73706E; font-size: 0.85rem; margin: 0; opacity: 0.8; font-style: italic;">
                        AI Powered Structured & Relational Data Analysis
                    </p>
                    <!-- Mode Toggle Button -->
                    <div class="mode-toggle-container">
                        <button class="mode-toggle-btn" id="databaseModeBtn" onclick="switchToDatabaseMode()">
                            <i class="fas fa-database"></i> Database Mode
                        </button>
                    </div>

                    <!-- TEMPLATE INFO CONTAINER -->
                    <div class="template-info-container" id="templateInfoContainer" style="display: none; margin-bottom: 15px;">
                        <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); border: 1px solid #00B190; border-radius: 10px; padding: 10px; font-size: 12px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <i class="fas fa-magic" style="color: #00B190; margin-right: 8px;"></i>
                                <strong>Template Active</strong>
                            </div>
                            <div id="templateName" style="font-weight: bold; color: #73706E;"></div>
                            <div id="templateDomain" style="color: #73706E; font-size: 11px; opacity: 0.8;"></div>
                            <div style="margin-top: 8px; display: flex; gap: 5px;">
                                <button class="btn btn-sm" style="background: #00B190; color: white; border: none; border-radius: 12px; padding: 3px 8px; font-size: 10px;" onclick="showTemplateDetails()">
                                    <i class="fas fa-info"></i> Details
                                </button>
                                <button class="btn btn-sm" style="background: #FF544F; color: white; border: none; border-radius: 12px; padding: 3px 8px; font-size: 10px;" onclick="removeTemplate()">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Connection Status -->
                <div class="mb-3" style="flex-shrink: 0;">
                    <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                    <small id="statusText">No data loaded</small>
                </div>
                
                <!-- Chat Container -->
                <div class="chat-container">
                    <div class="chat-header">
                        <span><i class="fas fa-comments"></i> Chat with Your Data</span>
                        <div class="chat-header-controls">
                            <button class="btn btn-sm btn-outline-light" id="collapseSidebar" title="Collapse Sidebar">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" id="clearChat" title="Clear Chat">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai-message">
                            <strong>AI:</strong> Upload your Excel or CSV files to start analyzing!
                            <br><small>💡 <em>Ask any question in the context of your data</em></small>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <div class="chat-input-container">
                            <textarea class="form-control" id="queryInput"
                                      placeholder="Ask about your data... (e.g., 'Show correlation matrix')"
                                      disabled rows="3"></textarea>
                            <button class="btn btn-primary chat-send-btn" type="button" id="sendQuery" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="col-md-9 content-area" id="contentArea">
                <!-- File Upload Area -->
                <div id="uploadArea" class="file-upload-area">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <h2 class="upload-title">Upload Your Files</h2>
                        <p class="upload-subtitle">Drag and drop files here or click to browse</p>
                        
                        <!-- Single Upload Button -->
                        <button class="upload-button" id="browseFiles">
                            <i class="fas fa-file-upload"></i> Browse Files
                        </button>
                        
                        <!-- Hidden file input -->
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" multiple>
                        
                        <!-- Upload information -->
                        <div class="upload-info">
                            <h5><i class="fas fa-info-circle" style="color: #005EEF;"></i> Supported Formats</h5>
                            <p><strong>📊 Excel Files:</strong> .xlsx, .xls (single file with multiple worksheets)</p>
                            <p><strong>📄 CSV Files:</strong> .csv (single file or multiple files)</p>
                            <p><strong>🔄 Auto-Combine:</strong> Multiple CSV files are automatically combined into one Excel workbook</p>
                            <p><strong>📏 File Size:</strong> Maximum 100MB per file</p>
                        </div>
                    </div>
                </div>
                
                <!-- File Information -->
                <div id="fileInfo" class="file-info hidden">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong><i class="fas fa-file-excel"></i> <span id="fileName"></span></strong>
                            <span class="ms-3">📊 <span id="fileRows"></span> rows × <span id="fileColumns"></span> columns</span>
                            <span id="csvCombinedInfo" class="ms-3 text-info hidden">
                                <i class="fas fa-magic"></i> Combined from <span id="csvCount"></span> CSV files
                            </span>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" id="uploadNew">
                            <i class="fas fa-upload"></i> Upload New
                        </button>
                    </div>
                </div>

                <!-- TEMPLATE SUGGESTIONS SECTION -->
                <div id="templateSuggestions" class="template-suggestions hidden" style="margin: 10px; padding: 12px; background: linear-gradient(135deg, #fff5f8 0%, #ffe6f2 100%); border: 1px solid #FF69B4; border-radius: 10px; font-size: 13px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <i class="fas fa-lightbulb" style="color: #FF69B4; margin-right: 8px;"></i>
                        <strong>Template Suggestions Available</strong>
                    </div>
                    <div id="suggestionsList"></div>
                    <button class="btn btn-sm" style="background: #FF69B4; color: white; border: none; border-radius: 15px; padding: 5px 12px; font-size: 11px; margin-top: 8px;" onclick="showTemplateSuggestions()">
                        <i class="fas fa-magic"></i> View Suggestions
                    </button>
                </div>

                <!-- Spreadsheet Container -->
                <div id="spreadsheetContainer" class="spreadsheet-container hidden">
                    <!-- MOVE THE HEADER OUTSIDE OF THE CONDITIONAL DISPLAY AREAS -->
                    <div class="spreadsheet-header">
                        <div class="spreadsheet-header-left">
                            <span><i class="fas fa-table"></i> <span id="currentViewLabel">Data View</span></span>
                            <!-- File info display - compact version -->
                            <span id="compactFileInfo" class="compact-file-info hidden">
                                <span class="file-name-display" id="compactFileName"></span>
                                <span class="file-stats" id="compactFileStats"></span>
                            </span>
                            <!-- Template suggestions indicator -->
                            <button id="templateSuggestionsBtn" class="template-suggestions-btn hidden" onclick="showTemplateSuggestions()" title="Template suggestions available">
                                <i class="fas fa-lightbulb"></i> Templates
                                <span class="suggestions-count" id="suggestionsCount"></span>
                            </button>
                        </div>
                        <div class="spreadsheet-controls">
                            <!-- Upload New button - moved here -->
                            <button class="btn btn-outline-light btn-sm" id="uploadNewHeader" title="Upload New File" style="display: none;">
                                <i class="fas fa-upload"></i>
                                <span>Upload New</span>
                            </button>

                            <!-- View Toggle - This will always be visible -->
                            <div class="view-toggle-container">
                                <span class="view-label">Spreadsheet</span>
                                <label class="view-toggle-switch">
                                    <input type="checkbox" id="viewToggle" onchange="toggleView()">
                                    <span class="slider"></span>
                                </label>
                                <span class="view-label">Outputs</span>
                            </div>

                            <button class="outputs-toggle" id="outputsToggle" title="Toggle Outputs Panel">
                                <i class="fas fa-chart-bar"></i> Outputs (<span id="outputCount">0</span>)
                            </button>
                            <button class="view-mode-toggle" id="viewModeToggle" title="Toggle Full Screen">
                                <i class="fas fa-expand"></i> Full Screen
                            </button>
                            <button class="btn btn-outline-light btn-sm" id="saveDocument" title="Save Changes">
                                <i class="fas fa-save"></i>
                                <span>Save</span>
                            </button>
                            <button class="btn btn-outline-light btn-sm" id="downloadExcel">
                                <i class="fas fa-download"></i>
                                <span>Download</span>
                            </button>
                        </div>
                    </div>

                    <!-- Spreadsheet View -->
                    <div class="onlyoffice-container" id="onlyofficeContainer">
                        <div class="editor-loading" id="editorLoading">
                            <div class="loading"></div>
                            <div>Loading OnlyOffice Editor...</div>
                        </div>
                        <div id="onlyoffice-editor"></div>
                    </div>

                    <!-- Outputs View Container -->
                    <div class="outputs-view-container" id="outputsViewContainer">
                        <div class="outputs-view-header">
                            <span><i class="fas fa-chart-line"></i> Output View</span>
                            <div>
                                <button class="btn btn-outline-light btn-sm" onclick="clearAllStackedOutputs()" title="Clear All Outputs">
                                    <i class="fas fa-trash"></i> Clear All
                                </button>
                            </div>
                        </div>
                        <div class="outputs-view-content" id="outputsViewContent">
                            <div class="outputs-view-empty" id="outputsViewEmpty">
                                <i class="fas fa-chart-line"></i>
                                <h4>No Analysis Outputs Yet</h4>
                                <p><small>Your analysis results will appear here.</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outputs Sidebar -->
            <div class="outputs-sidebar" id="outputsSidebar">
                <div class="outputs-header">
                    <span><i class="fas fa-chart-bar"></i> Output View</span>
                    <div>
                        <button class="btn btn-sm btn-outline-light" id="clearAllOutputs" title="Clear All">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-light" id="minimizeAllOutputs" title="Hide Panel">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-light" id="closeOutputsSidebar" title="Close Panel">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="outputs-list" id="outputsList">
                    <div style="text-align: center; color: #73706E; padding: 40px 20px;">
                        <i class="fas fa-chart-line" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>No analysis outputs yet</p>
                        <p><small>Start asking questions about your data!</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Outputs Overlay -->
    <div id="outputsOverlay" class="outputs-overlay"></div>
    
    <!-- Copy Notification -->
    <div id="copyNotification" class="copy-notification">
        <i class="fas fa-check"></i> Copied to clipboard!
    </div>
    
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle" title="Show Sidebar">
        <i class="fas fa-chevron-right"></i>
    </button>
    
    <!-- Charts Container -->
    <div id="chartsContainer" class="charts-container"></div>

    <!-- TEMPLATE MODALS -->
    <!-- Template Suggestions Modal -->
    <div class="modal fade" id="templateSuggestionsModal" tabindex="-1" style="z-index: 10000;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-magic"></i> Template Suggestions
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>We found some templates that might match your data structure:</p>
                    <div id="templateSuggestionsList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Not Now</button>
                    <button type="button" class="btn btn-primary" onclick="browseTemplates()">Browse All Templates</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Details Modal -->
    <div class="modal fade" id="templateDetailsModal" tabindex="-1" style="z-index: 10000;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #00B190 0%, #00d4aa 100%); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle"></i> Template Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="templateDetailsContent" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Template details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- All Templates Browser Modal -->
    <div class="modal fade" id="allTemplatesModal" tabindex="-1" style="z-index: 10000;">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #1F36C7 0%, #005EEF 100%); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-layer-group"></i> Available Templates
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row" id="allTemplatesList">
                        <!-- Templates will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentFile = null;
        let currentData = null;
        let onlyOfficeEditor = null;
        let chartCounter = 0;
        let activeCharts = new Map();
        let outputCounter = 0;
        let activeOutputs = new Map();
        let documentKey = null;
        let documentUrl = null;
        let isFullScreen = false;
        let editorReady = false;
        let selectedFiles = [];
        let outputsSidebarOpen = false;
        let lastOutputPosition = { x: 100, y: 100 };
        
        // OnlyOffice server configuration
        let ONLYOFFICE_SERVER_URL = 'http://localhost:8080';
        
        // Load configuration and OnlyOffice API
        fetch('/config')
            .then(response => response.json())
            .then(config => {
                ONLYOFFICE_SERVER_URL = config.onlyoffice_server_url;
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = `${ONLYOFFICE_SERVER_URL}/web-apps/apps/api/documents/api.js`;
                script.onerror = function() {
                    console.error('Failed to load OnlyOffice API script');
                };
                document.head.appendChild(script);
            })
            .catch(error => {
                console.error('Failed to load configuration:', error);
            });
        
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const browseFiles = document.getElementById('browseFiles');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileRows = document.getElementById('fileRows');
        const fileColumns = document.getElementById('fileColumns');
        const csvCombinedInfo = document.getElementById('csvCombinedInfo');
        const csvCount = document.getElementById('csvCount');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const queryInput = document.getElementById('queryInput');
        const sendQuery = document.getElementById('sendQuery');
        const chatMessages = document.getElementById('chatMessages');
        const spreadsheetContainer = document.getElementById('spreadsheetContainer');
        const clearChat = document.getElementById('clearChat');
        const uploadNew = document.getElementById('uploadNew');
        const chartsContainer = document.getElementById('chartsContainer');
        const downloadExcel = document.getElementById('downloadExcel');
        const saveDocument = document.getElementById('saveDocument');
        const editorLoading = document.getElementById('editorLoading');
        const viewModeToggle = document.getElementById('viewModeToggle');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const contentArea = document.getElementById('contentArea');
        const copyNotification = document.getElementById('copyNotification');
        const outputsOverlay = document.getElementById('outputsOverlay');

        // New global variables
        const uploadNewHeader = document.getElementById('uploadNewHeader');
        const templateSuggestionsBtn = document.getElementById('templateSuggestionsBtn');
        const compactFileInfo = document.getElementById('compactFileInfo');
        const compactFileName = document.getElementById('compactFileName');
        const compactFileStats = document.getElementById('compactFileStats');
        const suggestionsCount = document.getElementById('suggestionsCount');

        // Outputs sidebar elements
        const outputsSidebar = document.getElementById('outputsSidebar');
        const outputsToggle = document.getElementById('outputsToggle');
        const outputsList = document.getElementById('outputsList');
        const outputCount = document.getElementById('outputCount');
        const clearAllOutputs = document.getElementById('clearAllOutputs');
        const minimizeAllOutputs = document.getElementById('minimizeAllOutputs');
        const closeOutputsSidebar = document.getElementById('closeOutputsSidebar');

        // Event Listeners
        browseFiles.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileInput.click();
        });
        fileInput.addEventListener('change', handleFileSelect);
        sendQuery.addEventListener('click', sendUserQuery);
        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendUserQuery();
            }
            // Shift+Enter will create a new line (default textarea behavior)
        });
        clearChat.addEventListener('click', clearChatMessages);
        downloadExcel.addEventListener('click', downloadSpreadsheet);
        saveDocument.addEventListener('click', saveDocumentChanges);
        uploadNew.addEventListener('click', resetApplication);
        viewModeToggle.addEventListener('click', toggleFullScreen);
        sidebarToggle.addEventListener('click', toggleSidebar);
        outputsToggle.addEventListener('click', toggleOutputsSidebar);
        clearAllOutputs.addEventListener('click', clearAllOutputCards);
        //minimizeAllOutputs.addEventListener('click', minimizeAllOutputCards);
        minimizeAllOutputs.addEventListener('click', toggleOutputsSidebar);
        closeOutputsSidebar.addEventListener('click', hideOutputsSidebar);
        outputsOverlay.addEventListener('click', (e) => {
            // Only close if clicking directly on the overlay (not on cards above it)
            if (e.target === outputsOverlay) {
                hideOutputsSidebar();
            }
        });
        document.getElementById('collapseSidebar').addEventListener('click', collapseSidebar);
        document.getElementById('sidebarToggle').addEventListener('click', showSidebar);

        // New upload button
        uploadNewHeader.addEventListener('click', resetApplication);


        // Drag and Drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                handleDroppedFiles(files);
            }
        });

        uploadArea.addEventListener('click', (e) => {
            // Don't trigger if clicking the browse button or its content
            if (e.target.closest('#browseFiles')) {
                return;
            }

            if (e.target === uploadArea || e.target.closest('.upload-content')) {
                fileInput.click();
            }
        });
        
        // Click outside to close copy menus
        document.addEventListener('click', (e) => {
            const copyMenus = document.querySelectorAll('.copy-menu');
            copyMenus.forEach(menu => {
                if (!menu.contains(e.target) && !e.target.closest('.copy-btn')) {
                    menu.remove();
                }
            });
        });

        // handles database mode
        function switchToDatabaseMode() {
            window.location.href = '/database';
        }
        
        function toggleOutputsSidebar() {
            outputsSidebarOpen = !outputsSidebarOpen;
            const minimizeBtn = document.getElementById('minimizeAllOutputs');

            if (outputsSidebarOpen) {
                outputsSidebar.classList.add('open');
                outputsOverlay.classList.add('active');
                outputsToggle.classList.remove('has-hidden-outputs');
                outputsToggle.innerHTML = '<i class="fas fa-chart-bar"></i> Hide Outputs';
                outputsToggle.title = 'Hide outputs panel';

                // Reset button styling to normal
                outputsToggle.style.background = '';
                outputsToggle.style.color = '';
                outputsToggle.style.fontWeight = '';

                // Update minimize button to show hide icon
                if (minimizeBtn) {
                    minimizeBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    minimizeBtn.title = 'Hide Panel';
                }
            } else {
                hideOutputsSidebar();
            }
        }
        
        function hideOutputsSidebar() {
            outputsSidebarOpen = false;
            outputsSidebar.classList.remove('open');
            outputsOverlay.classList.remove('active');

            // Update the main outputs toggle button to make it clear it can reopen the sidebar
            if (activeOutputs.size > 0) {
                outputsToggle.innerHTML = `<i class="fas fa-chart-bar"></i> Show Outputs (${activeOutputs.size})`;
                outputsToggle.title = 'Click to show analysis outputs panel';
                outputsToggle.classList.add('has-hidden-outputs');

                // Make sure the button is visible and styled prominently
                outputsToggle.style.display = 'block';
                outputsToggle.style.background = 'linear-gradient(135deg, #FF69B4 0%, #FF1493 100%)';
                outputsToggle.style.color = 'white';
                outputsToggle.style.fontWeight = 'bold';
            }

            // Update minimize button (even though it's hidden, for when it reappears)
            const minimizeBtn = document.getElementById('minimizeAllOutputs');
            if (minimizeBtn) {
                minimizeBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                minimizeBtn.title = 'Hide Panel';
            }
        }
        
        function createOutputCard(data, query) {
            outputCounter++;
            const outputId = data.output_id || `output_${outputCounter}`;
            
            // Calculate position for new card
            const position = calculateOutputPosition();
            
            // Create output card
            const outputCard = document.createElement('div');
            outputCard.className = 'output-card new';
            outputCard.id = outputId;
            outputCard.style.left = position.x + 'px';
            outputCard.style.top = position.y + 'px';
            outputCard.style.width = '700px';
            outputCard.style.height = '500px';
            
            const truncatedQuery = query.length > 50 ? query.substring(0, 50) + '...' : query;
            const timestamp = new Date(data.timestamp).toLocaleTimeString();
            
            outputCard.innerHTML = `
                <div class="output-card-header">
                    <div class="output-card-title">
                        <i class="fas fa-chart-line"></i> ${truncatedQuery}
                    </div>
                    <div class="output-card-controls">
                        <button class="output-card-btn copy-btn" onclick="showCopyMenu(event, '${outputId}')" title="Copy">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="output-card-btn" onclick="minimizeOutputCard('${outputId}')" title="Minimize">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="output-card-btn" onclick="maximizeOutputCard('${outputId}')" title="Maximize">
                            <i class="fas fa-expand"></i>
                        </button>
                        <button class="output-card-btn danger" onclick="closeOutputCard('${outputId}')" title="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="output-card-content">
                    ${formatOutputForDisplay(data)}
                </div>
                <div class="resize-handle" onmousedown="startResize(event, '${outputId}')"></div>
            `;
            
            document.body.appendChild(outputCard);
            
            // Make draggable
            enableOutputCardDrag(outputCard);

            // if stuck
            addEmergencyRecovery(outputCard);
            
            // Store output data
            activeOutputs.set(outputId, {
                element: outputCard,
                data: data,
                query: query,
                timestamp: data.timestamp,
                minimized: false
            });
            
            // Add to outputs list
            addToOutputsList(outputId, query, timestamp);
            
            // Update counter
            updateOutputCount();
            
            // Focus the card
            focusOutputCard(outputId);
            
            // Remove 'new' class after animation
            setTimeout(() => {
                outputCard.classList.remove('new');
            }, 300);

            // If we're in outputs view, update the stacked view
            if (currentView === 'outputs') {
                setTimeout(() => {
                    updateOutputsView();
                }, 100);
            }
            
            return outputId;
        }
        
        function calculateOutputPosition() {
            const offset = 30;
            const maxX = window.innerWidth - 700;
            const maxY = window.innerHeight - 500;
            
            lastOutputPosition.x += offset;
            lastOutputPosition.y += offset;
            
            if (lastOutputPosition.x > maxX) {
                lastOutputPosition.x = 100;
            }
            if (lastOutputPosition.y > maxY) {
                lastOutputPosition.y = 100;
            }
            
            return { ...lastOutputPosition };
        }
        
        function addToOutputsList(outputId, query, timestamp) {
            const outputSummary = document.createElement('div');
            outputSummary.className = 'output-summary';
            outputSummary.id = `summary_${outputId}`;
            outputSummary.onclick = () => focusOutputCard(outputId);
            
            const time = new Date(timestamp).toLocaleTimeString();
            const truncatedQuery = query.length > 60 ? query.substring(0, 60) + '...' : query;
            
            outputSummary.innerHTML = `
                <div class="output-summary-title">${truncatedQuery}</div>
                <div class="output-summary-time">${time}</div>
                <div class="output-summary-type">Analysis</div>
            `;
            
            // Remove "no outputs" message if it exists
            const noOutputsMsg = outputsList.querySelector('div[style*="text-align: center"]');
            if (noOutputsMsg) {
                noOutputsMsg.remove();
            }
            
            outputsList.insertBefore(outputSummary, outputsList.firstChild);
        }
        
        function focusOutputCard(outputId) {
            // Remove active class from all cards
            document.querySelectorAll('.output-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Remove active class from all summaries
            document.querySelectorAll('.output-summary').forEach(summary => {
                summary.classList.remove('active');
            });
            
            // Add active class to selected card and summary
            const card = document.getElementById(outputId);
            const summary = document.getElementById(`summary_${outputId}`);
            
            if (card) {
                card.classList.add('active');
                // Bring to front
                card.style.zIndex = 1500 + activeOutputs.size;
            }
            
            if (summary) {
                summary.classList.add('active');
            }
        }
        
        function minimizeOutputCard(outputId) {
            document.body.style.cursor = '';
            document.body.style.userSelect = '';

            const output = activeOutputs.get(outputId);
            if (!output) return;
            
            const card = output.element;
            const minimizeBtn = card.querySelector('[onclick*="minimizeOutputCard"]');
            
            if (output.minimized) {
                // Restore
                card.classList.remove('minimized');
                output.minimized = false;
                minimizeBtn.innerHTML = '<i class="fas fa-minus"></i>';
                minimizeBtn.title = 'Minimize';
            } else {
                // Minimize
                card.classList.add('minimized');
                output.minimized = true;
                minimizeBtn.innerHTML = '<i class="fas fa-plus"></i>';
                minimizeBtn.title = 'Restore';
            }
        }
        
        function maximizeOutputCard(outputId) {
            document.body.style.cursor = '';
            document.body.style.userSelect = '';

            const output = activeOutputs.get(outputId);
            if (!output) return;
            
            const card = output.element;
            const maximizeBtn = card.querySelector('[onclick*="maximizeOutputCard"]');
            
            const isMaximized = card.style.width === '90vw';
            
            if (isMaximized) {
                // Restore
                card.style.width = '700px';
                card.style.height = '500px';
                card.style.left = '100px';
                card.style.top = '100px';
                maximizeBtn.innerHTML = '<i class="fas fa-expand"></i>';
                maximizeBtn.title = 'Maximize';
            } else {
                // Maximize
                card.style.width = '90vw';
                card.style.height = '80vh';
                card.style.left = '5vw';
                card.style.top = '10vh';
                maximizeBtn.innerHTML = '<i class="fas fa-compress"></i>';
                maximizeBtn.title = 'Restore';
            }
        }
        
        function closeOutputCard(outputId) {

            // CURSOR CLEANUP
            document.body.style.cursor = '';
            document.body.style.userSelect = '';

            const output = activeOutputs.get(outputId);
            if (!output) return;

            // Clean up any stuck states before removing
            const element = output.element;
            element.classList.remove('resizing');
            element.removeAttribute('data-resizing');
            
            // Remove card
            output.element.remove();
            
            // Remove from outputs list
            const summary = document.getElementById(`summary_${outputId}`);
            if (summary) {
                summary.remove();
            }
            
            // Remove from active outputs
            activeOutputs.delete(outputId);
            
            // Update counter
            updateOutputCount();
            
            // Show "no outputs" message if no outputs left
            if (activeOutputs.size === 0) {
                outputsList.innerHTML = `
                    <div style="text-align: center; color: #73706E; padding: 40px 20px;">
                        <i class="fas fa-chart-line" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>No analysis outputs yet</p>
                        <p><small>Start asking questions about your data!</small></p>
                    </div>
                `;
            }

            // Update outputs view if we're currently viewing it
            if (currentView === 'outputs') {
                setTimeout(() => {
                    updateOutputsView();
                }, 100);
            }
        }
        
        function clearAllOutputCards() {
            activeOutputs.forEach((output, outputId) => {
                closeOutputCard(outputId);
            });
        }
        
        function minimizeAllOutputCards() {
            activeOutputs.forEach((output, outputId) => {
                if (!output.minimized) {
                    minimizeOutputCard(outputId);
                }
            });
        }
        
        function updateOutputCount() {
            const count = activeOutputs.size;

            // Always show the toggle button if there are outputs
            if (count > 0) {
                outputsToggle.style.display = 'block';

                if (outputsSidebarOpen) {
                    outputsToggle.innerHTML = '<i class="fas fa-chart-bar"></i> Hide Outputs';
                    outputsToggle.style.background = '';
                    outputsToggle.style.color = '';
                } else {
                    outputsToggle.innerHTML = `<i class="fas fa-chart-bar"></i> Show Outputs (${count})`;
                    outputsToggle.style.background = 'linear-gradient(135deg, #FF69B4 0%, #FF1493 100%)';
                    outputsToggle.style.color = 'white';
                }
            } else {
                // Hide toggle when no outputs
                outputsToggle.style.display = 'none';
            }

            // Update the count span if it exists
            const countSpan = document.getElementById('outputCount');
            if (countSpan) {
                countSpan.textContent = count;
            }

            // Update outputs view if we're currently viewing it
            if (currentView === 'outputs') {
                updateOutputsView();
            }
        }
        
        function showCopyMenu(event, outputId) {
            event.stopPropagation();

            // Remove existing copy menus
            document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());

            const output = activeOutputs.get(outputId);
            if (!output) return;

            const copyMenu = document.createElement('div');
            copyMenu.className = 'copy-menu';
            copyMenu.style.left = event.pageX + 'px';
            copyMenu.style.top = event.pageY + 'px';

            // Check if output contains a chart/plot
            const hasChart = output.data.plot_data && Object.keys(output.data.plot_data).length > 0;

            if (hasChart) {
                // Chart-specific options
                copyMenu.innerHTML = `
                    <div class="copy-menu-item" onclick="downloadChartAsHTML('${outputId}')">
                        <i class="fas fa-file-code"></i> Download as Interactive HTML
                    </div>
                    <div class="copy-menu-item" onclick="openChartInNewTab('${outputId}')">
                        <i class="fas fa-external-link-alt"></i> Open in New Tab
                    </div>
                    <div class="copy-menu-item" onclick="copyChartAsHTML('${outputId}')">
                        <i class="fas fa-code"></i> Copy HTML Embed Code
                    </div>
                    <div class="copy-menu-item" onclick="copyPlotlyJSON('${outputId}')">
                        <i class="fas fa-brackets-curly"></i> Copy Plotly JSON
                    </div>
                    <div class="copy-menu-item" onclick="copyChartLink('${outputId}')">
                        <i class="fas fa-link"></i> Copy Shareable Link
                    </div>
                    <div class="copy-menu-item" onclick="downloadChartAsSVG('${outputId}')">
                        <i class="fas fa-vector-square"></i> Download as SVG
                    </div>
                    ${output.data.result ? `
                    <hr style="margin: 5px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <div class="copy-menu-item" onclick="copyOutputContent('${outputId}', 'csv')">
                        <i class="fas fa-file-csv"></i> Copy Data as CSV
                    </div>` : ''}
                `;
            } else {
                // Original menu for non-chart outputs
                copyMenu.innerHTML = `
                    <div class="copy-menu-item" onclick="copyOutputContent('${outputId}', 'text')">
                        <i class="fas fa-align-left"></i> Copy as Text
                    </div>
                    <div class="copy-menu-item" onclick="copyOutputContent('${outputId}', 'table')">
                        <i class="fas fa-table"></i> Copy as Table
                    </div>
                    <div class="copy-menu-item" onclick="copyOutputContent('${outputId}', 'json')">
                        <i class="fas fa-code"></i> Copy as JSON
                    </div>
                    <div class="copy-menu-item" onclick="copyOutputContent('${outputId}', 'csv')">
                        <i class="fas fa-file-csv"></i> Copy as CSV
                    </div>
                `;
            }

            document.body.appendChild(copyMenu);

            // Position menu to stay within viewport
            const rect = copyMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                copyMenu.style.left = (event.pageX - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                copyMenu.style.top = (event.pageY - rect.height) + 'px';
            }
        }
        
        function copyOutputContent(outputId, format) {
            const output = activeOutputs.get(outputId);
            if (!output) return;
            
            const content = output.element.querySelector('.output-card-content');
            let copyText = '';
            
            try {
                switch (format) {
                    case 'text':
                        // Get main content
                        copyText = content.textContent || content.innerText || '';

                        // Add insights if available
                        const insightsSection = content.querySelector('.insights-section');
                        if (insightsSection) {
                            const commentary = insightsSection.querySelector('.commentary-section');
                            const insights = insightsSection.querySelector('.insights-list');

                            copyText += '\n\n--- AI INSIGHTS ---\n';

                            if (commentary) {
                                copyText += 'Commentary: ' + (commentary.textContent || commentary.innerText) + '\n\n';
                            }

                            if (insights) {
                                copyText += 'Key Findings:\n' + (insights.textContent || insights.innerText);
                            }
                        }
                        break;

                    case 'table':
                        const table = content.querySelector('.output-table');
                        if (table) {
                            copyText = tableToTSV(table);
                        } else {
                            copyText = content.textContent || content.innerText || '';
                        }
                        break;
                        
                    case 'json':
                        try {
                            if (output.data && output.data.result) {
                                copyText = JSON.stringify(output.data.result, null, 2);
                            } else {
                                copyText = JSON.stringify(output.data, null, 2);
                            }
                        } catch (e) {
                            copyText = content.textContent || content.innerText || '';
                        }
                        break;
                        
                    case 'csv':
                        const csvTable = content.querySelector('.output-table');
                        if (csvTable) {
                            copyText = tableToCSV(csvTable);
                        } else {
                            copyText = content.textContent || content.innerText || '';
                        }
                        break;
                        
                    case 'plot':
                        // Handle plot copying
                        if (output.data.plot_data && Object.keys(output.data.plot_data).length > 0) {
                            copyPlot(outputId, content);
                            return; // Exit early as plot copying is handled differently
                        } else {
                            copyText = 'No plot data available';
                        }
                        break;
                        
                    default:
                        copyText = content.textContent || content.innerText || '';
                }
                
                // Enhanced copy functionality with better error handling
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(copyText).then(() => {
                        showCopyNotification();
                        document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
                    }).catch(err => {
                        console.warn('Clipboard API failed, using fallback:', err);
                        fallbackCopy(copyText);
                    });
                } else {
                    // Fallback for older browsers
                    fallbackCopy(copyText);
                }
                
            } catch (error) {
                console.error('Error copying content:', error);
                // Still try to copy something
                fallbackCopy(content.textContent || content.innerText || 'Error copying content');
            }
        }
        
        function copyPlot(outputId, content) {
            try {
                console.log('Copy plot called for output:', outputId);
                
                // Find all possible chart containers
                const chartContainers = [
                    content.querySelector('[id^="chart_"]'),
                    content.querySelector('.chart-content > div'),
                    content.querySelector('.chart-content'),
                    content.querySelector('[id*="chart"]')
                ].filter(el => el !== null);
                
                console.log('Found chart containers:', chartContainers);
                
                if (chartContainers.length === 0) {
                    console.warn('No chart container found for plot copying');
                    // Try to get plot data directly from output
                    const output = activeOutputs.get(outputId);
                    if (output && output.data.plot_data) {
                        const plotDataJson = JSON.stringify(output.data.plot_data, null, 2);
                        fallbackCopy(plotDataJson);
                        showCopyNotification('Plot data copied as JSON!');
                    } else {
                        fallbackCopy('No chart found to copy');
                    }
                    return;
                }
                
                const chartContainer = chartContainers[0];
                console.log('Using chart container:', chartContainer.id);
                
                // Check if Plotly is available and if the chart exists
                if (typeof Plotly !== 'undefined' && Plotly.toImage) {
                    // Wait a bit to ensure the chart is fully rendered
                    setTimeout(() => {
                        Plotly.toImage(chartContainer, {
                            format: 'png',
                            width: 1200,
                            height: 800,
                            scale: 2
                        }).then(function(dataUrl) {
                            console.log('Plot image generated successfully');
                            
                            // Try modern clipboard API first
                            if (navigator.clipboard && navigator.clipboard.write) {
                                // Convert data URL to blob
                                fetch(dataUrl)
                                    .then(res => res.blob())
                                    .then(blob => {
                                        const item = new ClipboardItem({ 'image/png': blob });
                                        return navigator.clipboard.write([item]);
                                    })
                                    .then(() => {
                                        showCopyNotification('Plot copied as image!');
                                        document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
                                    })
                                    .catch(err => {
                                        console.warn('Modern clipboard failed, trying fallback:', err);
                                        // Fallback: try to copy data URL as text
                                        if (navigator.clipboard && navigator.clipboard.writeText) {
                                            navigator.clipboard.writeText(dataUrl).then(() => {
                                                showCopyNotification('Plot data URL copied!');
                                                document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
                                            }).catch(() => {
                                                fallbackCopy(dataUrl);
                                            });
                                        } else {
                                            fallbackCopy(dataUrl);
                                        }
                                    });
                            } else {
                                // Fallback for older browsers
                                console.log('Using fallback copy method');
                                fallbackCopy(dataUrl);
                            }
                            
                        }).catch(function(error) {
                            console.error('Error generating plot image:', error);
                            // Fallback: copy plot data as JSON
                            const output = activeOutputs.get(outputId);
                            if (output && output.data.plot_data) {
                                const plotDataJson = JSON.stringify(output.data.plot_data, null, 2);
                                fallbackCopy(plotDataJson);
                                showCopyNotification('Plot data copied as JSON!');
                            } else {
                                fallbackCopy('Error copying plot - no data available');
                            }
                        });
                    }, 500); // Wait 500ms for chart to fully render
                } else {
                    console.warn('Plotly.toImage not available, falling back to JSON');
                    // Fallback: copy plot data as JSON
                    const output = activeOutputs.get(outputId);
                    if (output && output.data.plot_data) {
                        const plotDataJson = JSON.stringify(output.data.plot_data, null, 2);
                        fallbackCopy(plotDataJson);
                        showCopyNotification('Plot data copied as JSON!');
                    } else {
                        fallbackCopy('No plot data available');
                    }
                }
                
            } catch (error) {
                console.error('Error in copyPlot:', error);
                const output = activeOutputs.get(outputId);
                if (output && output.data.plot_data) {
                    const plotDataJson = JSON.stringify(output.data.plot_data, null, 2);
                    fallbackCopy(plotDataJson);
                    showCopyNotification('Plot data copied as JSON (fallback)!');
                } else {
                    fallbackCopy('Error copying plot');
                }
            }
        }
        
        function fallbackCopy(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const result = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (result) {
                    showCopyNotification();
                } else {
                    console.error('Fallback copy failed');
                    alert('Copy failed. Please select the text manually and copy with Ctrl+C');
                }
                
                document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
            } catch (err) {
                console.error('Fallback copy error:', err);
                alert('Copy not supported in this browser. Please select text manually.');
                document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
            }
        }


        // Download chart as standalone interactive HTML
        function downloadChartAsHTML(outputId) {
            const output = activeOutputs.get(outputId);
            if (!output || !output.data.plot_data) return;

            const plotData = output.data.plot_data;
            const query = output.query;

            // Build HTML content as a string without template literals
            const htmlContent = '<!DOCTYPE html>' +
                '<html lang="en">' +
                '<head>' +
                '<meta charset="UTF-8">' +
                '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
                '<title>' + escapeHtml(query) + ' - Interactive Chart</title>' +
                '<script src="https://cdn.plot.ly/plotly-latest.min.js"></' + 'script>' +
                '<style>' +
                'body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }' +
                'h1 { color: #333; font-size: 1.5em; margin-bottom: 20px; }' +
                '#chart { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; }' +
                '.metadata { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px; font-size: 0.9em; color: #666; }' +
                '</style>' +
                '</head>' +
                '<body>' +
                '<h1>' + escapeHtml(query) + '</h1>' +
                '<div id="chart"></div>' +
                '<div class="metadata">' +
                'Generated: ' + new Date().toLocaleString() + '<br>' +
                'Source: Data Analysis Platform' +
                '</div>' +
                '<script>' +
                'const plotData = ' + JSON.stringify(plotData) + ';' +
                'Plotly.newPlot("chart", plotData.data, plotData.layout || {}, {responsive: true});' +
                '</' + 'script>' +
                '</body>' +
                '</html>';

            // Create blob and download
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chart_' + query.replace(/[^a-z0-9]/gi, '_').substring(0, 30) + '_' + Date.now() + '.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showCopyNotification('Interactive chart downloaded as HTML!');
            document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
        }

        // Open chart in new tab
        function openChartInNewTab(outputId) {
            const output = activeOutputs.get(outputId);
            if (!output || !output.data.plot_data) return;

            const plotData = output.data.plot_data;
            const query = output.query;

            // Create HTML content using string concatenation
            const htmlContent = '<!DOCTYPE html>' +
                '<html>' +
                '<head>' +
                '<title>' + escapeHtml(query) + ' - Chart</title>' +
                '<script src="https://cdn.plot.ly/plotly-latest.min.js"></' + 'script>' +
                '<style>' +
                'body { margin: 0; padding: 0; }' +
                '#chart { width: 100vw; height: 100vh; }' +
                '</style>' +
                '</head>' +
                '<body>' +
                '<div id="chart"></div>' +
                '<script>' +
                'const plotData = ' + JSON.stringify(plotData) + ';' +
                'Plotly.newPlot("chart", plotData.data, plotData.layout || {}, {responsive: true});' +
                '</' + 'script>' +
                '</body>' +
                '</html>';

            // Open in new window
            const newWindow = window.open('', '_blank');
            if (newWindow) {
                newWindow.document.write(htmlContent);
                newWindow.document.close();
            }

            document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
        }

        // Copy chart as embeddable HTML
        function copyChartAsHTML(outputId) {
            const output = activeOutputs.get(outputId);
            if (!output || !output.data.plot_data) return;

            const plotData = output.data.plot_data;
            const divId = 'plotly_chart_' + Date.now();

            // Build embed code using string concatenation
            const embedCode = '<!-- Plotly Chart Embed -->\n' +
                '<div id="' + divId + '" style="width: 100%; height: 500px;"></div>\n' +
                '<script src="https://cdn.plot.ly/plotly-latest.min.js"></' + 'script>\n' +
                '<script>\n' +
                '    Plotly.newPlot("' + divId + '", \n' +
                '        ' + JSON.stringify(plotData.data, null, 2) + ', \n' +
                '        ' + JSON.stringify(plotData.layout || {}, null, 2) + ', \n' +
                '        {responsive: true}\n' +
                '    );\n' +
                '</' + 'script>\n' +
                '<!-- End Plotly Chart -->';

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(embedCode).then(() => {
                    showCopyNotification('HTML embed code copied!');
                });
            } else {
                fallbackCopy(embedCode);
            }

            document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
        }


        // Copy Plotly JSON configuration
        function copyPlotlyJSON(outputId) {
            const output = activeOutputs.get(outputId);
            if (!output || !output.data.plot_data) return;

            const plotlyConfig = {
                data: output.data.plot_data.data,
                layout: output.data.plot_data.layout || {},
                config: {responsive: true}
            };

            const jsonStr = JSON.stringify(plotlyConfig, null, 2);

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(jsonStr).then(() => {
                    showCopyNotification('Plotly JSON configuration copied!');
                });
            } else {
                fallbackCopy(jsonStr);
            }

            document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
        }

        // Generate and copy shareable link (requires backend support)
        function copyChartLink(outputId) {
            const output = activeOutputs.get(outputId);
            if (!output || !output.data.plot_data) return;

            // Store chart data temporarily in sessionStorage
            const chartId = `chart_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            sessionStorage.setItem(chartId, JSON.stringify({
                query: output.query,
                plotData: output.data.plot_data,
                timestamp: output.timestamp
            }));

            // Create a shareable link
            const shareableLink = `${window.location.origin}${window.location.pathname}?chart=${chartId}`;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareableLink).then(() => {
                    showCopyNotification('Shareable link copied! (Valid for this session only)');
                });
            } else {
                fallbackCopy(shareableLink);
            }

            document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
        }

        // Download chart as SVG
        function downloadChartAsSVG(outputId) {
            const output = activeOutputs.get(outputId);
            if (!output || !output.data.plot_data) return;

            // Find the chart container
            const chartDiv = output.element.querySelector('[id^="chart_"]');
            if (!chartDiv) return;

            // Use Plotly's downloadImage function
            Plotly.downloadImage(chartDiv, {
                format: 'svg',
                width: 1200,
                height: 800,
                filename: `chart_${output.query.replace(/[^a-z0-9]/gi, '_').substring(0, 30)}`
            }).then(() => {
                showCopyNotification('Chart downloaded as SVG!');
            }).catch(error => {
                console.error('Error downloading SVG:', error);
                showCopyNotification('Error downloading SVG. Trying alternative method...');

                // Alternative: get SVG from DOM
                const svg = chartDiv.querySelector('svg');
                if (svg) {
                    const svgData = new XMLSerializer().serializeToString(svg);
                    const blob = new Blob([svgData], { type: 'image/svg+xml' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `chart_${Date.now()}.svg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }
            });

            document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
        }
        
        function tableToTSV(table) {
            const rows = table.querySelectorAll('tr');
            return Array.from(rows).map(row => {
                const cells = row.querySelectorAll('th, td');
                return Array.from(cells).map(cell => cell.textContent.trim()).join('\t');
            }).join('\n');
        }
        
        function tableToCSV(table) {
            const rows = table.querySelectorAll('tr');
            return Array.from(rows).map(row => {
                const cells = row.querySelectorAll('th, td');
                return Array.from(cells).map(cell => {
                    const text = cell.textContent.trim();
                    // Escape quotes and wrap in quotes if contains comma or quote
                    if (text.includes(',') || text.includes('"')) {
                        return `"${text.replace(/"/g, '""')}"`;
                    }
                    return text;
                }).join(',');
            }).join('\n');
        }
        
        function enableOutputCardDrag(element) {
            let isDragging = false;
            let dragOffset = { x: 0, y: 0 };

            const header = element.querySelector('.output-card-header');
            if (!header) return;

            function startDrag(e) {
                    // Don't drag if clicking on buttons or if resizing
                    if (e.target.closest('.output-card-btn') || element.classList.contains('resizing')) {
                        return;
                    }

                    isDragging = true;
                    const rect = element.getBoundingClientRect();
                    dragOffset.x = e.clientX - rect.left;
                    dragOffset.y = e.clientY - rect.top;

                    header.style.cursor = 'grabbing';
                    document.body.style.userSelect = 'none';

                    e.preventDefault();
                    e.stopPropagation();

                    // Focus the card when starting to drag
                    focusOutputCard(element.id);
                }

            function doDrag(e) {
                if (!isDragging || element.classList.contains('resizing')) {
                    return;
                }

                e.preventDefault();
                e.stopPropagation();

                const x = e.clientX - dragOffset.x;
                const y = e.clientY - dragOffset.y;

                const maxX = window.innerWidth - element.offsetWidth;
                const maxY = window.innerHeight - element.offsetHeight;

                element.style.left = Math.max(0, Math.min(x, maxX)) + 'px';
                element.style.top = Math.max(0, Math.min(y, maxY)) + 'px';
            }

            function stopDrag(e) {
                if (!isDragging) return;

                isDragging = false;
                header.style.cursor = 'move';
                document.body.style.userSelect = '';

                e.preventDefault();
                e.stopPropagation();

                // Remove event listeners
                document.removeEventListener('mousemove', doDrag, true);
                document.removeEventListener('mouseup', stopDrag, true);
            }

            header.addEventListener('mousedown', (e) => {
                startDrag(e);

                // Use capture phase and add listeners only when needed
                document.addEventListener('mousemove', doDrag, true);
                document.addEventListener('mouseup', stopDrag, true);

                // Safety timeout
                setTimeout(() => {
                    if (isDragging) {
                        console.warn('Drag operation timed out, cleaning up');
                        stopDrag(e);
                    }
                }, 30000);
            });
        }

        // Emergency recovery function for stuck cards
        function emergencyRecoverCard(outputId) {
            const output = activeOutputs.get(outputId);
            if (!output) return;

            const element = output.element;

            // Remove all problematic states
            element.classList.remove('resizing');
            element.removeAttribute('data-resizing');

            // Reset styles
            element.style.cursor = '';
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            document.documentElement.style.cursor = ''; // Also clean document cursor

            // Reset header cursor
            const header = element.querySelector('.output-card-header');
            if (header) {
                header.style.cursor = 'move';
            }

            // Clean up any lingering event listeners on document
            const newDocument = document.cloneNode(true);
            // Note: Don't actually replace document, just clean up our specific listeners

            console.log('Emergency recovery applied to card:', outputId);
        }

        // Add double-click emergency recovery to card headers
        function addEmergencyRecovery(element) {
            const header = element.querySelector('.output-card-header');
            if (header) {
                header.addEventListener('dblclick', (e) => {
                    if (e.shiftKey) { // Shift + double-click for emergency recovery
                        emergencyRecoverCard(element.id);
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
            }
        }

        // Max card size
        function getMaximumCardSize() {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            return {
                maxWidth: Math.max(800, viewportWidth * 0.95), // At least 800px or 95% of viewport
                maxHeight: Math.max(600, viewportHeight * 0.9)  // At least 600px or 90% of viewport
            };
        }

        function startResize(event, outputId) {
            event.preventDefault();
            event.stopPropagation();

            const output = activeOutputs.get(outputId);
            if (!output) return;

            const element = output.element;
            const startX = event.clientX;
            const startY = event.clientY;
            const startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
            const startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);

            // Add resizing class instead of data attribute
            element.classList.add('resizing');

            // Store original cursor
            const originalCursor = document.body.style.cursor;
            document.body.style.cursor = 'se-resize';

            let resizeTimeout;
            let isResizing = true;

            function doResize(e) {
                if (!isResizing) return;

                e.preventDefault();
                e.stopPropagation();

                // more generous resize constraints
                const maxSizes = getMaximumCardSize();
                const newWidth = Math.max(300, Math.min(startWidth + e.clientX - startX, maxSizes.maxWidth));
                const newHeight = Math.max(200, Math.min(startHeight + e.clientY - startY, maxSizes.maxHeight));

                element.style.width = newWidth + 'px';
                element.style.height = newHeight + 'px';

                // Replace the throttled Plotly resize section with:
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    const chartDiv = element.querySelector('.chart-content > div, [id^="chart_"]');
                    if (chartDiv && typeof Plotly !== 'undefined' && Plotly.Plots) {
                        try {
                            // Calculate actual available height
                            const cardRect = element.getBoundingClientRect();
                            const headerHeight = 60; // Fixed header height
                            const padding = 60; // Content padding + chart padding

                            const newHeight = Math.max(250, cardRect.height - headerHeight - padding);
                            const newWidth = Math.max(350, cardRect.width - 40);

                            Plotly.relayout(chartDiv, {
                                width: newWidth,
                                height: newHeight
                            });
                        } catch (error) {
                            console.log('Plotly resize warning:', error);
                        }
                    }
                }, 150);
            }

            function stopResize(e) {
                if (!isResizing) return;

                isResizing = false;
                e.preventDefault();
                e.stopPropagation();

                // Clean up
                element.classList.remove('resizing');
                document.body.style.cursor = originalCursor;

                // Remove event listeners
                document.removeEventListener('mousemove', doResize, true);
                document.removeEventListener('mouseup', stopResize, true);

                // Final Plotly resize
                clearTimeout(resizeTimeout);
                setTimeout(() => {
                    const chartDiv = element.querySelector('.chart-content > div, [id^="chart_"]');
                    if (chartDiv && typeof Plotly !== 'undefined' && Plotly.Plots) {
                        try {
                            Plotly.Plots.resize(chartDiv);
                        } catch (error) {
                            console.log('Plotly final resize warning:', error);
                        }
                    }
                }, 100);
            }

            // Use capture phase to ensure our handlers run first
            document.addEventListener('mousemove', doResize, true);
            document.addEventListener('mouseup', stopResize, true);

            // Safety timeout to prevent stuck resize state
            setTimeout(() => {
                if (isResizing) {
                    console.warn('Resize operation timed out, cleaning up');
                    stopResize(event);
                }
            }, 30000); // 30 second timeout
        }
        
        function showCopyNotification(message = 'Copied to clipboard!') {
            copyNotification.innerHTML = '<i class="fas fa-check"></i> ' + message;
            copyNotification.classList.add('show');
            setTimeout(() => {
                copyNotification.classList.remove('show');
            }, 2000);
        }
        
        // Enhanced table formatting with pagination support
        class PaginatedTable {
            constructor(data, containerId, rowsPerPage = 100) {
                this.data = data;
                this.containerId = containerId;
                this.rowsPerPage = rowsPerPage;
                this.currentPage = 1;
                this.totalPages = Math.ceil(data.length / rowsPerPage);
                this.render();
            }
            
            render() {
                const container = document.getElementById(this.containerId);
                if (!container) return;
                
                const html = `
                    <div class="table-container">
                        <div class="table-info">
                            <i class="fas fa-info-circle"></i>
                            Displaying ${this.data.length} rows with pagination for better performance
                        </div>
                        <div class="table-controls">
                            <div class="pagination-info">
                                Page ${this.currentPage} of ${this.totalPages} 
                                (${this.data.length} total rows)
                            </div>
                            <div class="pagination-controls">
                                <label>Rows per page:</label>
                                <select class="rows-per-page" onchange="changeRowsPerPage_${this.containerId}(this.value)">
                                    <option value="50" ${this.rowsPerPage === 50 ? 'selected' : ''}>50</option>
                                    <option value="100" ${this.rowsPerPage === 100 ? 'selected' : ''}>100</option>
                                    <option value="250" ${this.rowsPerPage === 250 ? 'selected' : ''}>250</option>
                                    <option value="500" ${this.rowsPerPage === 500 ? 'selected' : ''}>500</option>
                                    <option value="${this.data.length}" ${this.rowsPerPage >= this.data.length ? 'selected' : ''}>All</option>
                                </select>
                                <button class="pagination-btn" onclick="goToPage_${this.containerId}(1)" ${this.currentPage === 1 ? 'disabled' : ''}>
                                    <i class="fas fa-angle-double-left"></i>
                                </button>
                                <button class="pagination-btn" onclick="goToPage_${this.containerId}(${this.currentPage - 1})" ${this.currentPage === 1 ? 'disabled' : ''}>
                                    <i class="fas fa-angle-left"></i>
                                </button>
                                <button class="pagination-btn" onclick="goToPage_${this.containerId}(${this.currentPage + 1})" ${this.currentPage === this.totalPages ? 'disabled' : ''}>
                                    <i class="fas fa-angle-right"></i>
                                </button>
                                <button class="pagination-btn" onclick="goToPage_${this.containerId}(${this.totalPages})" ${this.currentPage === this.totalPages ? 'disabled' : ''}>
                                    <i class="fas fa-angle-double-right"></i>
                                </button>
                            </div>
                        </div>
                        ${this.generateTable()}
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Store reference for pagination functions
                window[`changeRowsPerPage_${this.containerId}`] = (newRowsPerPage) => {
                    this.rowsPerPage = parseInt(newRowsPerPage);
                    this.totalPages = Math.ceil(this.data.length / this.rowsPerPage);
                    this.currentPage = 1;
                    this.render();
                };
                
                window[`goToPage_${this.containerId}`] = (page) => {
                    this.currentPage = Math.max(1, Math.min(page, this.totalPages));
                    this.render();
                };
            }
            
            generateTable() {
                if (this.data.length === 0) return '<div class="output-single-value">No data</div>';
                
                const headers = Object.keys(this.data[0]);
                const startIndex = (this.currentPage - 1) * this.rowsPerPage;
                const endIndex = Math.min(startIndex + this.rowsPerPage, this.data.length);
                const pageData = this.data.slice(startIndex, endIndex);
                
                let html = '<table class="output-table"><thead><tr>';
                headers.forEach(header => {
                    html += `<th>${header}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                pageData.forEach(row => {
                    html += '<tr>';
                    headers.forEach(header => {
                        const value = row[header] !== null && row[header] !== undefined ? row[header] : '';
                        html += `<td>${value}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                return html;
            }
        }
        
        function formatOutputForDisplay(data) {
            let mainContent = '';

            // Handle combined outputs (both data and chart)
            if (data.plot_data && Object.keys(data.plot_data).length > 0 && data.result) {
                mainContent = formatCombinedOutput(data);
            }
            // Handle chart-only outputs
            else if (data.plot_data && Object.keys(data.plot_data).length > 0) {
                mainContent = formatChartOutput(data.plot_data);
            }
            // Handle result only
            else if (data.result) {
                mainContent = formatResult(data.result);
            }
            else {
                mainContent = '<div class="output-single-value">Analysis completed successfully!</div>';
            }

            // Add toggleable code section (for all output types when code is available)
            const codeSection = formatCodeSection(data);

            // Add commentary and insights section
            const insightsSection = formatInsightsSection(data);

            return mainContent + codeSection + insightsSection;
        }

        function formatCodeSection(data) {
            if (!data.code) {
                return '';
            }

            const uniqueId = `code_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            return `
                <div class="code-section">
                    <button class="code-toggle-btn" onclick="toggleCodeDisplay('${uniqueId}', this)">
                        <i class="fas fa-chevron-right"></i>
                        <span>Show Generated Code</span>
                    </button>
                    <div class="code-content" id="${uniqueId}">
                        <div class="output-code-block">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: #ecf0f1;">Generated Python Code:</strong>
                                <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); border: none; color: #ecf0f1; padding: 4px 10px; border-radius: 4px;" onclick="copyCode('${uniqueId}')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(data.code)}</pre>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatInsightsSection(data) {
            const commentary = data.commentary || '';
            const insights = data.insights || [];

            // Only show insights section if we have commentary or insights
            if (!commentary && (!insights || insights.length === 0)) {
                return '';
            }

            let insightsHtml = `
                <div class="insights-section" style="margin-top: 20px; border-top: 2px solid #005EEF; padding-top: 15px;">
                    <div class="insights-header" style="background: linear-gradient(135deg, #e8f2ff 0%, #f0f4ff 100%); padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #005EEF;">
                        <i class="fas fa-lightbulb" style="color: #005EEF; margin-right: 8px;"></i>
                        <strong style="color: #73706E;">AI Insights</strong>
                    </div>
            `;

            // Add commentary if available
            if (commentary) {
                insightsHtml += `
                    <div class="commentary-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border: 1px solid #005EEF; border-radius: 8px; padding: 12px 15px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <i class="fas fa-comment-dots" style="color: #005EEF; margin-top: 2px; flex-shrink: 0;"></i>
                            <div style="color: #73706E; line-height: 1.5; font-size: 14px;">
                                ${commentary}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Add insights if available
            if (insights && insights.length > 0) {
                insightsHtml += `
                    <div class="insights-list" style="background: linear-gradient(135deg, #fff5f8 0%, #ffe6f2 100%); border: 1px solid #FF69B4; border-radius: 8px; padding: 15px;">
                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                            <i class="fas fa-chart-line" style="color: #FF69B4; margin-right: 8px;"></i>
                            <strong style="color: #73706E; font-size: 14px;">Key Findings</strong>
                        </div>
                        <ul style="margin: 0; padding-left: 20px; color: #73706E;">
                `;

                insights.forEach(insight => {
                    insightsHtml += `<li style="margin-bottom: 8px; line-height: 1.4; font-size: 13px;">${insight}</li>`;
                });

                insightsHtml += `
                        </ul>
                    </div>
                `;
            }

            insightsHtml += '</div>';

            return insightsHtml;
        }

        function formatCombinedOutput(data) {
            const combinedId = `combined_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            let html = `<div class="combined-output" id="${combinedId}">`;

            // Add toggle switch header
            html += `
                <div class="combined-output-header">
                    <div class="output-toggle-container">
                        <span class="toggle-label ${data.plot_data ? 'active' : ''}" data-view="chart">
                            <i class="fas fa-chart-line"></i> Chart
                        </span>
                        <label class="output-toggle-switch">
                            <input type="checkbox" id="toggle_${combinedId}" ${!data.plot_data ? 'checked' : ''} onchange="toggleCombinedView('${combinedId}')">
                            <span class="output-slider"></span>
                        </label>
                        <span class="toggle-label ${!data.plot_data ? 'active' : ''}" data-view="data">
                            <i class="fas fa-table"></i> Data
                        </span>
                    </div>
                </div>
            `;

            // Chart section - visible by default if plot data exists
            if (data.plot_data && Object.keys(data.plot_data).length > 0) {
                html += `
                    <div class="combined-section chart-section active" id="chart_section_${combinedId}">
                        ${formatChartOutput(data.plot_data, combinedId + '_chart')}
                    </div>
                `;
            }

            // Data section - UPDATED with copy button
            if (data.result) {
                const isActive = !data.plot_data || Object.keys(data.plot_data).length === 0;
                html += `
                    <div class="combined-section data-section ${isActive ? 'active' : ''}" id="data_section_${combinedId}">
                        <div class="data-section-header">
                            <div class="data-section-title">
                                <i class="fas fa-table"></i> Data Analysis Results
                            </div>
                            <div class="data-section-controls">
                                <button class="data-copy-btn" onclick="showDataCopyMenu(event, '${combinedId}')" title="Copy Data">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        <div class="full-data-content" id="data_content_${combinedId}">
                            ${formatResult(data.result)}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // to handle the toggle between chart and data views
        function toggleCombinedView(combinedId) {
            const container = document.getElementById(combinedId);
            const toggle = document.getElementById(`toggle_${combinedId}`);
            const chartSection = document.getElementById(`chart_section_${combinedId}`);
            const dataSection = document.getElementById(`data_section_${combinedId}`);
            const toggleLabels = container.querySelectorAll('.toggle-label');

            if (toggle.checked) {
                // Show data, hide chart
                if (chartSection) {
                    chartSection.classList.remove('active');
                }
                if (dataSection) {
                    dataSection.classList.add('active');
                }

                // Update label states
                toggleLabels.forEach(label => {
                    if (label.dataset.view === 'data') {
                        label.classList.add('active');
                    } else {
                        label.classList.remove('active');
                    }
                });
            } else {
                // Show chart, hide data
                if (chartSection) {
                    chartSection.classList.add('active');
                }
                if (dataSection) {
                    dataSection.classList.remove('active');
                }

                // Update label states
                toggleLabels.forEach(label => {
                    if (label.dataset.view === 'chart') {
                        label.classList.add('active');
                    } else {
                        label.classList.remove('active');
                    }
                });
            }

            // Resize chart if it becomes visible
            if (!toggle.checked && chartSection) {
                setTimeout(() => {
                    const chartDiv = chartSection.querySelector('[id^="chart_"]');
                    if (chartDiv && typeof Plotly !== 'undefined' && Plotly.Plots) {
                        try {
                            Plotly.Plots.resize(chartDiv);
                        } catch (error) {
                            console.log('Chart resize warning:', error);
                        }
                    }
                }, 300);
            }
        }

        function toggleCodeDisplay(codeId, button) {
            const codeContent = document.getElementById(codeId);
            const isShowing = codeContent.classList.contains('show');

            if (isShowing) {
                codeContent.classList.remove('show');
                button.classList.remove('expanded');
                button.querySelector('span').textContent = 'Show Generated Code';
            } else {
                codeContent.classList.add('show');
                button.classList.add('expanded');
                button.querySelector('span').textContent = 'Hide Generated Code';
            }
        }

        function copyCode(codeId) {
            const codeElement = document.getElementById(codeId);
            const codeText = codeElement.querySelector('pre').textContent;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(codeText).then(() => {
                    showCopyNotification('Code copied to clipboard!');
                }).catch(() => {
                    fallbackCopy(codeText);
                });
            } else {
                fallbackCopy(codeText);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add helper function to detect minimal data
        function isMinimalData(result) {
            if (typeof result === 'string' && result.length < 100) return true;
            if (typeof result === 'number') return true;
            if (Array.isArray(result) && result.length < 5) return true;
            if (typeof result === 'object' && Object.keys(result).length < 3) return true;
            return false;
        }

        // Add toggle function for data section
        function toggleDataSection(headerElement) {
            const section = headerElement.closest('.data-section');
            const content = section.querySelector('.data-content');
            const icon = headerElement.querySelector('.toggle-icon');

            if (content.style.display === 'none') {
                // Expand
                content.style.display = 'block';
                section.classList.remove('collapsed');
                icon.className = 'fas fa-chevron-up toggle-icon';
            } else {
                // Collapse
                content.style.display = 'none';
                section.classList.add('collapsed');
                icon.className = 'fas fa-chevron-down toggle-icon';
            }

            // Trigger Plotly resize after layout change
            setTimeout(() => {
                const chartDiv = section.closest('.output-card').querySelector('[id^="chart_"]');
                if (chartDiv && typeof Plotly !== 'undefined' && Plotly.Plots) {
                    Plotly.Plots.resize(chartDiv);
                }
            }, 300);
        }
        
        function formatChartOutput(plotData, chartId = null) {
            const uniqueId = chartId || `chart_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const html = `
                <div class="embedded-chart">
                    <div class="chart-header">
                        <i class="fas fa-chart-line"></i> Interactive Chart
                    </div>
                    <div class="chart-content" id="${uniqueId}"></div>
                </div>
            `;

            setTimeout(() => {
                const chartContainer = document.getElementById(uniqueId);
                if (chartContainer) {
                    try {
                        // Just ensure the container takes full height
                        chartContainer.style.height = '100%';
                        chartContainer.style.minHeight = '600px';

                        const responsiveLayout = {
                            ...plotData.layout,
                            autosize: true, // Keep autosize enabled
                            margin: { l: 50, r: 50, t: 50, b: 50 }
                        };

                        // Handle facet spacing issues for plots with many columns
                        if (plotData.layout && plotData.layout.annotations) {
                            const colCount = plotData.data.length;
                            if (colCount > 10) {
                                responsiveLayout.showlegend = false;
                            }
                            if (colCount > 20) {
                                responsiveLayout.margin = { l: 30, r: 30, t: 40, b: 40 };
                            }
                        }

                        const plotConfig = {
                            responsive: true, // Keep responsive enabled
                            displayModeBar: true,
                            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                            displaylogo: false
                        };

                        Plotly.newPlot(chartContainer, plotData.data, responsiveLayout, plotConfig);

                    } catch (error) {
                        console.error('Error creating embedded chart:', error);
                        chartContainer.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #FF544F;">
                                <i class="fas fa-exclamation-triangle"></i><br>
                                Chart rendering error<br>
                                <small>The plot may have too many data points or columns. Try filtering your data first.</small>
                            </div>
                        `;
                    }
                }
            }, 200);
            return html;
        }
        
        function formatResult(result) {
            return formatResultRecursive(result, 0);
        }

        function formatResultRecursive(result, depth = 0) {
            if (typeof result === 'string' || typeof result === 'number') {
                return `<div class="output-single-value">${result}</div>`;
            }

            if (Array.isArray(result)) {
                if (result.length > 0 && typeof result[0] === 'object') {
                    return formatArrayAsTable(result);
                } else {
                    return `<div class="output-single-value">${result.join(', ')}</div>`;
                }
            }

            if (typeof result === 'object' && result !== null) {
                if (isTabularData(result)) {
                    return formatObjectAsTable(result);
                } else {
                    return formatNestedDictionary(result, depth);
                }
            }

            return `<div class="output-single-value">${JSON.stringify(result)}</div>`;
        }

        function formatNestedDictionary(obj, depth = 0) {
            const maxDepth = 3; // Prevent infinite nesting
            if (depth > maxDepth) {
                return `<div class="output-single-value">${JSON.stringify(obj)}</div>`;
            }

            const uniqueId = `dict_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            let html = '';

            // If it's a top-level dictionary or has many keys, use sections
            if (depth === 0 || Object.keys(obj).length > 3) {
                html += '<div class="nested-dictionary">';

                for (const [key, value] of Object.entries(obj)) {
                    const sectionId = `section_${uniqueId}_${key}`;
                    const formattedValue = formatDictionaryValue(value, depth + 1);
                    const isComplex = isComplexValue(value);

                    if (isComplex) {
                        // Create collapsible section for complex values
                        html += `
                            <div class="dictionary-section">
                                <div class="dictionary-section-header" onclick="toggleDictionarySection('${sectionId}')">
                                    <i class="fas fa-chevron-right toggle-icon" id="icon_${sectionId}"></i>
                                    <strong>${escapeHtml(key)}</strong>
                                    <span class="value-type-badge">${getValueTypeBadge(value)}</span>
                                </div>
                                <div class="dictionary-section-content" id="${sectionId}" style="display: none;">
                                    ${formattedValue}
                                </div>
                            </div>
                        `;
                    } else {
                        // Show simple values inline
                        html += `
                            <div class="dictionary-simple-item">
                                <strong>${escapeHtml(key)}:</strong> ${formattedValue}
                            </div>
                        `;
                    }
                }

                html += '</div>';
            } else {
                // For small nested objects, use inline table format
                html += '<table class="output-table nested-table"><thead><tr><th>Property</th><th>Value</th></tr></thead><tbody>';

                for (const [key, value] of Object.entries(obj)) {
                    const formattedValue = formatDictionaryValue(value, depth + 1);
                    html += `<tr><td><strong>${escapeHtml(key)}</strong></td><td>${formattedValue}</td></tr>`;
                }

                html += '</tbody></table>';
            }

            return html;
        }

        function formatDictionaryValue(value, depth) {
            if (value === null || value === undefined) {
                return '<span class="null-value">null</span>';
            }

            if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {
                return `<span class="simple-value">${escapeHtml(String(value))}</span>`;
            }

            if (Array.isArray(value)) {
                if (value.length === 0) {
                    return '<span class="empty-array">[]</span>';
                } else if (value.length <= 5 && value.every(item => typeof item !== 'object')) {
                    // Show small arrays of primitives inline
                    return `<span class="inline-array">[${value.map(v => escapeHtml(String(v))).join(', ')}]</span>`;
                } else {
                    // Use full array formatting for complex arrays
                    return formatResultRecursive(value, depth);
                }
            }

            if (typeof value === 'object') {
                return formatResultRecursive(value, depth);
            }

            return `<span class="unknown-value">${escapeHtml(String(value))}</span>`;
        }

        function isComplexValue(value) {
            if (Array.isArray(value)) {
                return value.length > 5 || value.some(item => typeof item === 'object');
            }
            if (typeof value === 'object' && value !== null) {
                return Object.keys(value).length > 2;
            }
            return false;
        }

        function getValueTypeBadge(value) {
            if (Array.isArray(value)) {
                return `<span class="type-badge array">${value.length} items</span>`;
            }
            if (typeof value === 'object' && value !== null) {
                const keyCount = Object.keys(value).length;
                return `<span class="type-badge object">${keyCount} properties</span>`;
            }
            return `<span class="type-badge primitive">${typeof value}</span>`;
        }

        function toggleDictionarySection(sectionId) {
            const content = document.getElementById(sectionId);
            const icon = document.getElementById(`icon_${sectionId}`);

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            } else {
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            }
        }

        function isTabularData(obj) {
            const keys = Object.keys(obj);
            if (keys.length === 0) return false;
            
            const firstValue = obj[keys[0]];
            if (!Array.isArray(firstValue)) return false;
            
            const expectedLength = firstValue.length;
            return keys.every(key => Array.isArray(obj[key]) && obj[key].length === expectedLength);
        }
        
        function formatArrayAsTable(data) {
            if (data.length === 0) return '<div class="output-single-value">No data</div>';
            
            const tableId = `table_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            // Create container and initialize paginated table
            setTimeout(() => {
                new PaginatedTable(data, tableId, 100);
            }, 50);
            
            return `<div id="${tableId}"></div>`;
        }
        
        function formatObjectAsTable(data) {
            const keys = Object.keys(data);
            const length = data[keys[0]].length;
            
            // Convert object format to array format for pagination
            const arrayData = [];
            for (let i = 0; i < length; i++) {
                const row = {};
                keys.forEach(key => {
                    row[key] = data[key][i] !== null && data[key][i] !== undefined ? data[key][i] : '';
                });
                arrayData.push(row);
            }
            
            const tableId = `table_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            // Create container and initialize paginated table
            setTimeout(() => {
                new PaginatedTable(arrayData, tableId, 100);
            }, 50);
            
            return `<div id="${tableId}"></div>`;
        }
        
        function formatObjectAsKeyValue(obj) {
            let html = '<table class="output-table"><thead><tr><th>Property</th><th>Value</th></tr></thead><tbody>';
            
            for (const [key, value] of Object.entries(obj)) {
                let displayValue = value;
                if (typeof value === 'object' && value !== null) {
                    displayValue = JSON.stringify(value, null, 2);
                }
                html += `<tr><td><strong>${key}</strong></td><td>${displayValue}</td></tr>`;
            }
            
            html += '</tbody></table>';
            return html;
        }
        
        // File handling functions (keeping existing functionality)
        function handleDroppedFiles(files) {
            selectedFiles = files;
            uploadFiles();
        }
        
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                selectedFiles = files;
                uploadFiles();
            }
        }

        // Enhanced success message processing for templates
        function enhanceSuccessMessageWithTemplate(message, data) {
            // If we have template information, enhance the success message
            if (data.template_info && data.template_info.detected) {
                let templateMessage = '';

                if (data.template_info.multi_worksheet_template) {
                    // Multi-worksheet template detected
                    templateMessage = ` 🎯 Detected as "${data.template_info.template_name}" template (${data.template_info.template_type}). `;
                    templateMessage += 'This provides enhanced analysis capabilities across your worksheets including cross-sheet relationships and template-specific metrics!';

                    // Add worksheet mapping summary if available
                    if (data.template_info.worksheet_mapping) {
                        const mappings = data.template_info.worksheet_mapping;
                        const matchedSheets = mappings.filter(m => m.matched_worksheet).length;
                        const totalSheets = mappings.length;
                        templateMessage += ` Successfully mapped ${matchedSheets}/${totalSheets} expected worksheets.`;
                    }
                } else {
                    // Single worksheet template
                    templateMessage = ` 🎯 Detected as "${data.template_info.template_name}" template, providing enhanced analysis context and business metrics!`;
                }

                return message + templateMessage;
            }

            return message;
        }

        function uploadFiles() {
            if (selectedFiles.length === 0) return;
            
            const allowedExtensions = ['csv', 'xlsx', 'xls'];
            const invalidFiles = selectedFiles.filter(file => {
                const extension = file.name.split('.').pop().toLowerCase();
                return !allowedExtensions.includes(extension);
            });
            
            if (invalidFiles.length > 0) {
                addMessage('ai', `❌ Invalid file types detected: ${invalidFiles.map(f => f.name).join(', ')}. Please upload only CSV, XLSX, or XLS files.`, true);
                fileInput.value = '';
                selectedFiles = [];
                return;
            }
            
            if (selectedFiles.length > 1) {
                const csvFiles = selectedFiles.filter(f => f.name.toLowerCase().endsWith('.csv'));
                const excelFiles = selectedFiles.filter(f => f.name.toLowerCase().endsWith('.xlsx') || f.name.toLowerCase().endsWith('.xls'));
                
                if (excelFiles.length > 0) {
                    addMessage('ai', '❌ When uploading multiple files, all files must be CSV format. For Excel files, please upload one file at a time.', true);
                    fileInput.value = '';
                    selectedFiles = [];
                    return;
                }
            }
            
            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('file', file);
            });
            
            if (selectedFiles.length > 1) {
                addMessage('system', `Uploading and combining ${selectedFiles.length} CSV files into Excel workbook...`);
            } else {
                addMessage('system', 'Uploading and processing file...');
            }
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentFile = data.filename;
                    documentKey = data.document_key;
                    documentUrl = data.document_url;

                    const editorFilename = data.display_filename || data.filename;

                    // Update compact file info in header instead of separate bar
                    compactFileName.textContent = data.filename;
                    compactFileStats.textContent = `📊 ${data.shape[0]} rows × ${data.shape[1]} columns`;

                    if (data.is_combined_csv) {
                        compactFileStats.textContent += ` (${data.csv_count} CSV files combined)`;
                    }

                    // Show compact file info and upload new button in header
                    compactFileInfo.classList.remove('hidden');
                    uploadNewHeader.style.display = 'block';

                    // Hide the old bars and mark them as integrated
                    fileInfo.classList.add('hidden', 'header-integrated');
                    const templateSuggestions = document.getElementById('templateSuggestions');
                    if (templateSuggestions) {
                        templateSuggestions.classList.add('hidden', 'header-integrated');
                    }

                    uploadArea.style.display = 'none';
                    initializeOnlyOfficeEditor(data.document_url, data.document_key, editorFilename);

                    statusIndicator.className = 'status-indicator status-connected';
                    queryInput.disabled = false;
                    sendQuery.disabled = false;
                    window.currentDataSummary = data.summary;

                    // ENHANCED SAFE SUCCESS MESSAGE WITH ALL FEATURES
                    let message = 'File "' + data.filename + '" loaded successfully! ';
                    message += 'Your data is now in the OnlyOffice spreadsheet with ';
                    message += data.shape[0] + ' rows and ' + data.shape[1] + ' columns. ';

                    // Handle different file types and worksheet scenarios
                    if (data.is_combined_csv) {
                        // Multiple CSV files combined
                        message += 'I have combined your ' + data.csv_count + ' CSV files into a single Excel workbook. ';
                        message += 'The combined file contains ' + data.csv_count + ' worksheets - you can switch between them using OnlyOffice. ';
                        message += 'You can ask questions about specific worksheets or analyze data across all worksheets! ';
                    } else {
                        // Single file (Excel or single CSV)
                        if (data.has_multiple_worksheets) {
                            // Multiple worksheets - show actual count if available
                            let worksheetCount = 'multiple';
                            let cleaningInfo = '';

                            if (data.excel_processing_info) {
                                if (data.excel_processing_info.clean_worksheets) {
                                    worksheetCount = data.excel_processing_info.clean_worksheets;
                                }

                                // Add cleaning information
                                if (data.excel_processing_info.skipped_worksheets && data.excel_processing_info.skipped_worksheets > 0) {
                                    cleaningInfo = 'I have cleaned up your Excel file - kept ' +
                                                  data.excel_processing_info.clean_worksheets +
                                                  ' analyzable worksheet(s) and removed ' +
                                                  data.excel_processing_info.skipped_worksheets +
                                                  ' problematic ones.';
                                } else if (data.excel_processing_info.clean_worksheets) {
                                    cleaningInfo = ' I have optimized your Excel file for analysis.';
                                }
                            }

                            if (typeof worksheetCount === 'number') {
                                message += 'The file contains ' + worksheetCount + ' worksheets - you can switch between them using OnlyOffice.';
                            } else {
                                message += 'The file contains multiple worksheets - you can switch between them using OnlyOffice.';
                            }

                            message += cleaningInfo;
                            message += ' You can ask questions about specific worksheets or analyze data across all worksheets! ';
                        } else {
                            // Single worksheet
                            message += 'The file contains 1 worksheet with your data. ';

                            // Add cleaning info for single worksheet if available
                            if (data.excel_processing_info && data.excel_processing_info.clean_worksheets) {
                                message += 'I have optimized your Excel file for analysis. ';
                            }
                        }
                    }

                    message += 'Ask me questions about your data and I will provide analysis and visualizations!';

                    // Enhanced status text with more details
                    let statusMsg = '';
                    if (data.has_multiple_worksheets) {
                        if (data.excel_processing_info && data.excel_processing_info.clean_worksheets) {
                            statusMsg = ' (' + data.excel_processing_info.clean_worksheets + ' worksheets)';
                        } else {
                            statusMsg = ' (multiple worksheets)';
                        }
                    }

                    let csvMsg = '';
                    if (data.is_combined_csv) {
                        csvMsg = ' - Combined from ' + data.csv_count + ' CSV files';
                    }

                    statusText.textContent = 'Data loaded successfully' + statusMsg + csvMsg;

                    // DEBUG: Log the data to see what we're working with (optional - remove in production)
                    //console.log('=== SUCCESS MESSAGE DEBUG ===');
                    //console.log('Upload response data:', data);
                    //console.log('Excel processing info:', data.excel_processing_info);
                    //console.log('Has multiple worksheets:', data.has_multiple_worksheets);
                    //console.log('Is combined CSV:', data.is_combined_csv);
                    //console.log('Final message:', message);
                    //console.log('============================');

                    // Send the enhanced success message
                    const enhancedMessage = enhanceSuccessMessageWithTemplate(message, data);
                    addMessage('ai', enhancedMessage);

                    // Process template information from upload response
                    processTemplateInfoFromUpload(data);

                } else {
                    addMessage('ai', `❌ ${data.error}`, true);
                }
            })
            .catch(error => {
                addMessage('ai', `Error uploading file(s): ${error.message}`, true);
            })
            .finally(() => {
                fileInput.value = '';
                selectedFiles = [];
            });
        }
        
        function sendUserQuery() {
            const query = queryInput.value.trim();
            if (!query) return;
            
            addMessage('user', query);
            queryInput.value = '';
            
            addMessage('ai', 'Processing your request...', false, true);
            
            fetch('/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                removeLastLoadingMessage();
                
                if (data.success) {
                    // Create output card instead of showing in output panel
                    createOutputCard(data, query);
                    
                    // Add confirmation message to chat
                    addMessage('ai', '✅ Analysis completed! Check the new output card for results.');
                    
                    // Auto-open outputs sidebar if not open
                    if (!outputsSidebarOpen) {
                        toggleOutputsSidebar();
                    }
                    
                } else {
                    addMessage('ai', `❌ ${data.error}`, true);
                }
            })
            .catch(error => {
                removeLastLoadingMessage();
                addMessage('ai', `❌ Error processing query: ${error.message}`, true);
            });
        }
        
        // Keep existing functions for OnlyOffice, file handling, etc. (unchanged)
        
        function initializeOnlyOfficeEditor(docUrl, docKey, filename) {
            editorLoading.style.display = 'block';
            spreadsheetContainer.classList.remove('hidden');
            spreadsheetContainer.classList.add('normal-mode');
            editorReady = false;
            
            let fileExtension = 'xlsx';
            if (filename && filename.includes('.')) {
                fileExtension = filename.split('.').pop().toLowerCase();
            }
            
            const validSpreadsheetTypes = ['xlsx', 'xls', 'csv', 'ods', 'xlsm', 'xlsb'];
            if (!validSpreadsheetTypes.includes(fileExtension)) {
                console.warn(`Invalid file type: ${fileExtension}, defaulting to xlsx`);
                fileExtension = 'xlsx';
            }
            
            console.log(`Initializing OnlyOffice with file type: ${fileExtension}, filename: ${filename}`);
            
            const config = {
                "document": {
                    "fileType": fileExtension,
                    "key": docKey,
                    "title": filename || "Spreadsheet",
                    "url": docUrl,
                    "permissions": {
                        "edit": true,
                        "download": true,
                        "print": true
                    }
                },
                "documentType": "cell",
                "editorConfig": {
                    "mode": "edit",
                    "lang": "en",
                    "callbackUrl": `${window.location.origin}/onlyoffice/callback`,
                    "customization": {
                        "autosave": true,
                        "forcesave": false,
                        "compactToolbar": false,
                        "toolbar": true,
                        "statusbar": true,
                        "chat": false,
                        "comments": true,
                        "zoom": 100,
                        "compactHeader": false,
                        "toolbarNoTabs": false,
                        "toolbarHideFileName": false
                    },
                    "user": {
                        "id": "user1",
                        "name": "User"
                    }
                },
                "width": "100%",
                "height": "100%",
                "events": {
                    "onAppReady": onEditorReady,
                    "onDocumentStateChange": onDocumentStateChange,
                    "onError": onEditorError
                }
            };
            
            const editorContainer = document.getElementById('onlyoffice-editor');
            editorContainer.innerHTML = '';
            
            console.log('OnlyOffice editor config:', config);
            
            try {
                onlyOfficeEditor = new DocsAPI.DocEditor("onlyoffice-editor", config);
            } catch (error) {
                console.error('Error initializing OnlyOffice editor:', error);
                editorLoading.style.display = 'none';
                addMessage('ai', `❌ Error initializing spreadsheet editor: ${error.message}`, true);
            }
        }
        
        function onEditorReady() {
            console.log('OnlyOffice editor is ready');
            editorLoading.style.display = 'none';
            editorReady = true;
            
            addMessage('ai', '✅ OnlyOffice spreadsheet editor is ready! You can now edit the document and ask me questions about your data. I\'ll provide analysis results in floating output cards.');
        }
        
        function onDocumentStateChange(event) {
            console.log('Document state changed:', event);
        }
        
        function onEditorError(event) {
            console.error('OnlyOffice editor error:', event);
            editorLoading.style.display = 'none';
            editorReady = false;
            addMessage('ai', `❌ Editor error: ${event.data}`, true);
        }
        
        function saveDocumentChanges() {
            if (onlyOfficeEditor) {
                addMessage('system', 'Saving document changes...');
            }
        }
        
        function downloadSpreadsheet() {
            if (!currentFile) {
                addMessage('ai', '❌ No file to download. Please upload a file first.', true);
                return;
            }
            
            downloadExcel.classList.add('btn-downloading');
            const downloadText = downloadExcel.querySelector('span');
            const originalText = downloadText.textContent;
            downloadText.textContent = 'Preparing...';
            
            fetch('/download', {
                method: 'GET'
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Download failed');
                    });
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const baseName = currentFile.split('.')[0];
                a.download = `${baseName}_analyzed_${timestamp}.xlsx`;
                
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                addMessage('ai', `✅ Spreadsheet downloaded successfully as "${a.download}"`);
            })
            .catch(error => {
                console.error('Download error:', error);
                addMessage('ai', `❌ Error downloading file: ${error.message}`, true);
            })
            .finally(() => {
                downloadExcel.classList.remove('btn-downloading');
                downloadText.textContent = originalText;
            });
        }
        
        function toggleFullScreen() {
            isFullScreen = !isFullScreen;

            if (isFullScreen) {
                // Store current sidebar state before going fullscreen
                window.sidebarStateBeforeFullscreen = sidebar.classList.contains('collapsed');

                spreadsheetContainer.classList.add('fullscreen-mode');
                spreadsheetContainer.classList.remove('normal-mode');
                sidebar.classList.add('collapsed');
                contentArea.classList.add('expanded');
                contentArea.classList.remove('sidebar-collapsed'); // Remove this to avoid conflicts
                sidebarToggle.classList.remove('show'); // Use 'show' instead of 'hidden'

                viewModeToggle.innerHTML = '<i class="fas fa-compress"></i> Exit Full Screen';

            } else {
                spreadsheetContainer.classList.remove('fullscreen-mode');
                spreadsheetContainer.classList.add('normal-mode');

                // Restore previous sidebar state
                if (window.sidebarStateBeforeFullscreen) {
                    // Sidebar was collapsed before fullscreen
                    sidebar.classList.add('collapsed');
                    contentArea.classList.add('sidebar-collapsed');
                    contentArea.classList.remove('expanded');
                    sidebarToggle.classList.add('show');
                } else {
                    // Sidebar was expanded before fullscreen
                    sidebar.classList.remove('collapsed');
                    contentArea.classList.remove('expanded', 'sidebar-collapsed');
                    sidebarToggle.classList.remove('show');
                }

                viewModeToggle.innerHTML = '<i class="fas fa-expand"></i> Full Screen';
            }

            setTimeout(() => {
                if (onlyOfficeEditor) {
                    try {
                        console.log('Full screen toggled, OnlyOffice should auto-resize');
                    } catch (error) {
                        console.log('OnlyOffice resize error:', error);
                    }
                }
            }, 350);
        }
        
        function toggleSidebar() {
            if (window.innerWidth <= 768) {
                // Mobile behavior (existing)
                sidebar.classList.toggle('show');
            } else {
                // Desktop behavior
                if (sidebar.classList.contains('collapsed')) {
                    showSidebar();
                } else {
                    collapseSidebar();
                }
            }
        }

        function collapseSidebar() {
            sidebar.classList.add('collapsed');
            contentArea.classList.add('sidebar-collapsed');
            sidebarToggle.classList.add('show');

            // Update icon
            const toggleIcon = sidebarToggle.querySelector('i');
            toggleIcon.className = 'fas fa-chevron-right';
            sidebarToggle.title = 'Show Sidebar';

            // Force OnlyOffice to resize - multiple approaches
            setTimeout(() => {
                // Method 1: Window resize event
                window.dispatchEvent(new Event('resize'));

                // Method 2: Force reflow of OnlyOffice container
                const editorElement = document.getElementById('onlyoffice-editor');
                if (editorElement) {
                    const currentDisplay = editorElement.style.display;
                    editorElement.style.display = 'none';
                    editorElement.offsetHeight; // Force reflow
                    editorElement.style.display = currentDisplay || '';
                }

                // Method 3: Trigger another resize after reflow
                setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 100);

            }, 350);
        }

        function showSidebar() {
            sidebar.classList.remove('collapsed');
            contentArea.classList.remove('sidebar-collapsed');
            sidebarToggle.classList.remove('show');

            // Update icon
            const toggleIcon = sidebarToggle.querySelector('i');
            toggleIcon.className = 'fas fa-chevron-right';
            sidebarToggle.title = 'Show Sidebar';

            // Force OnlyOffice to resize back
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));

                const editorElement = document.getElementById('onlyoffice-editor');
                if (editorElement) {
                    const currentDisplay = editorElement.style.display;
                    editorElement.style.display = 'none';
                    editorElement.offsetHeight; // Force reflow
                    editorElement.style.display = currentDisplay || '';
                }

                setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 100);

            }, 350);
        }

        function resetApplication() {
            currentFile = null;
            currentData = null;
            documentKey = null;
            documentUrl = null;
            isFullScreen = false;
            editorReady = false;
            selectedFiles = [];

            // Reset view to spreadsheet
            currentView = 'spreadsheet';
            const viewToggle = document.getElementById('viewToggle');
            if (viewToggle) {
                viewToggle.checked = false;
            }
            const outputsViewContainer = document.getElementById('outputsViewContainer');
            if (outputsViewContainer) {
                outputsViewContainer.classList.remove('active');
            }

            // Make sure floating cards are shown (in case they were hidden)
            showAllFloatingCards();

            // Clear template information
            hideTemplateInfo();
            hideTemplateSuggestionsSection();
            currentTemplate = null;
            templateSuggestions = [];

            // Reset header components
            compactFileInfo.classList.add('hidden');
            uploadNewHeader.style.display = 'none';
            templateSuggestionsBtn.classList.add('hidden');

            // Remove header-integrated classes from old bars
            uploadArea.style.display = 'flex';
            fileInfo.classList.remove('header-integrated');
            const templateSuggestionsDiv = document.getElementById('templateSuggestions');
            if (templateSuggestionsDiv) {
                templateSuggestionsDiv.classList.remove('header-integrated');
            }

            if (onlyOfficeEditor) {
                try {
                    onlyOfficeEditor.destroyEditor();
                } catch (error) {
                    console.warn('Error destroying OnlyOffice editor:', error);
                }
                onlyOfficeEditor = null;
            }

            // Clear all outputs and charts
            clearAllOutputCards();
            activeCharts.forEach((chart, chartId) => {
                closePersistentChart(chartId);
            });
            activeCharts.clear();
            chartCounter = 0;

            // Close outputs sidebar
            if (outputsSidebarOpen) {
                hideOutputsSidebar();
            }

            spreadsheetContainer.classList.remove('fullscreen-mode', 'normal-mode');
            sidebar.classList.remove('collapsed');
            contentArea.classList.remove('expanded', 'outputs-view-active');
            sidebarToggle.classList.remove('show');
            contentArea.classList.remove('col-md-12');
            contentArea.classList.add('col-md-9');
            viewModeToggle.innerHTML = '<i class="fas fa-expand"></i> Full Screen';

            uploadArea.style.display = 'flex';
            fileInfo.classList.add('hidden');
            csvCombinedInfo.classList.add('hidden');
            fileInfo.classList.remove('csv-combined');
            spreadsheetContainer.classList.add('hidden');

            statusIndicator.className = 'status-indicator status-disconnected';
            statusText.textContent = 'No data loaded';
            queryInput.disabled = true;
            sendQuery.disabled = true;
            clearChatMessages();

            fileInput.value = '';

            fetch('/reset_session', {method: 'POST'}).catch(e => console.log('Reset warning:', e));
        }

        function addMessage(type, content, isError = false, isLoading = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            if (isLoading) {
                messageDiv.innerHTML = `<div class="loading"></div> ${content}`;
                messageDiv.classList.add('loading-message');
            } else {
                const prefix = type === 'user' ? '<strong>You:</strong> ' : 
                              type === 'system' ? '<strong>System:</strong> ' : 
                              '<strong>AI:</strong> ';
                messageDiv.innerHTML = prefix + content;
                
                if (isError) {
                    messageDiv.style.borderLeft = '3px solid #FF544F';
                }
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function removeLastLoadingMessage() {
            const loadingMessages = chatMessages.querySelectorAll('.loading-message');
            if (loadingMessages.length > 0) {
                loadingMessages[loadingMessages.length - 1].remove();
            }
        }
        
        function clearChatMessages() {
            // ADDED: Call backend to clear session history
            fetch('/clear_chat', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Session history cleared successfully');
                } else {
                    console.error('Error clearing session history:', data.error);
                }
            })
            .catch(error => {
                console.error('Error clearing session history:', error);
            });
            
            // Clear chat messages in frontend
            chatMessages.innerHTML = `
                <div class="message ai-message">
                    <strong>AI:</strong> Chat cleared! Upload your Excel or CSV files to start analyzing your data.
                </div>
            `;
        }
        
        // Legacy chart functions (kept for compatibility)
        function createPersistentChart(chartData, title) {
            // This function is kept for compatibility but not used anymore
            // Charts are now embedded directly in output cards
            console.log('createPersistentChart called but charts are now embedded');
        }
        
        function closePersistentChart(chartId) {
            const chartElement = document.getElementById(chartId);
            if (chartElement) {
                chartElement.remove();
                activeCharts.delete(chartId);
            }
        }
        
        // Window resize handler
        window.addEventListener('resize', function() {
            if (onlyOfficeEditor && spreadsheetContainer && !spreadsheetContainer.classList.contains('hidden')) {
                clearTimeout(window.resizeTimeout);
                window.resizeTimeout = setTimeout(function() {
                    try {
                        console.log('Window resized, OnlyOffice should auto-adjust');
                    } catch (error) {
                        console.log('Resize handler: OnlyOffice not ready');
                    }
                }, 300);
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F11' || (e.altKey && e.key === 'Enter')) {
                e.preventDefault();
                if (!spreadsheetContainer.classList.contains('hidden')) {
                    toggleFullScreen();
                }
            }
            
            if (e.key === 'Escape') {
                if (isFullScreen) {
                    toggleFullScreen();
                } else {
                    // Close any open copy menus
                    document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
                }
            }
        });

        // TEMPLATE MANAGEMENT FUNCTIONS

        // Template-related variables
        let currentTemplate = null;
        let templateSuggestions = [];

        // Enhanced template details function
        function showTemplateDetails() {
            if (!currentTemplate) return;

            // Fetch detailed template information including worksheet mapping
            Promise.all([
                fetch('/api/templates/current').then(response => response.json()),
                fetch('/api/templates/worksheet_mapping').then(response => response.json())
            ]).then(([templateData, mappingData]) => {
                if (templateData.success && templateData.template) {
                    displayEnhancedTemplateDetails(templateData.template, templateData.validation, mappingData);
                }
            }).catch(error => {
                console.error('Error fetching template details:', error);
                // Fallback to basic template details
                fetch('/api/templates/current')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.template) {
                            displayTemplateDetails(data.template, data.validation);
                        }
                    });
            });
        }

        // NEW function for enhanced template details display
        function displayEnhancedTemplateDetails(template, validation, mappingData) {
            const content = document.getElementById('templateDetailsContent');

            let validationHtml = '';
            if (validation) {
                validationHtml = `
                    <div class="card mb-3">
                        <div class="card-header">
                            <i class="fas fa-check-circle"></i> Data Validation
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <strong>Status:</strong>
                                <span class="badge ${validation.is_valid ? 'bg-success' : 'bg-warning'}">
                                    ${validation.is_valid ? 'Valid' : 'Issues Found'}
                                </span>
                            </div>
                            ${validation.warnings && validation.warnings.length > 0 ? `
                                <div class="mb-2">
                                    <strong>Warnings:</strong>
                                    <ul class="mb-0">
                                        ${validation.warnings.map(w => `<li>${w}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${validation.errors && validation.errors.length > 0 ? `
                                <div class="mb-2">
                                    <strong>Errors:</strong>
                                    <ul class="mb-0">
                                        ${validation.errors.map(e => `<li class="text-danger">${e}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Enhanced worksheet mapping display
            let worksheetMappingHtml = '';
            if (mappingData && mappingData.success && mappingData.is_multi_worksheet) {
                worksheetMappingHtml = `
                    <div class="card mb-3">
                        <div class="card-header">
                            <i class="fas fa-layer-group"></i> Worksheet Mapping
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Template Type:</strong> ${mappingData.template_type}<br>
                                <strong>Expected Worksheets:</strong> ${mappingData.template_info.total_worksheets}<br>
                                <strong>Required Worksheets:</strong> ${mappingData.template_info.required_worksheets}<br>
                                <strong>Match Summary:</strong> ${mappingData.summary.found_worksheets}/${mappingData.summary.total_template_worksheets} found (${mappingData.summary.match_percentage.toFixed(1)}%)
                            </div>

                            <h6>Worksheet Details:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Template Worksheet</th>
                                            <th>Status</th>
                                            <th>Matched To</th>
                                            <th>Columns</th>
                                            <th>Required</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${mappingData.worksheet_mapping.map(mapping => `
                                            <tr>
                                                <td>
                                                    <strong>${mapping.worksheet_name}</strong><br>
                                                    <small class="text-muted">${mapping.template_description}</small>
                                                </td>
                                                <td>
                                                    <span class="badge ${mapping.found ? 'bg-success' : 'bg-danger'}">
                                                        ${mapping.found ? 'Found' : 'Missing'}
                                                    </span>
                                                </td>
                                                <td>${mapping.matched_worksheet || '-'}</td>
                                                <td>${mapping.columns_matched}/${mapping.columns_expected}</td>
                                                <td>
                                                    <span class="badge ${mapping.is_required ? 'bg-warning' : 'bg-secondary'}">
                                                        ${mapping.is_required ? 'Required' : 'Optional'}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-info"></i> Template Information
                    </div>
                    <div class="card-body">
                        <h6>${template.name}</h6>
                        <p><strong>Domain:</strong> ${template.domain}</p>
                        <p><strong>Version:</strong> ${template.version}</p>
                        <p><strong>Type:</strong> ${template.template_type || 'single_worksheet'}</p>
                        <p><strong>Description:</strong> ${template.description}</p>
                        <p><strong>Applied:</strong> ${template.manually_applied ? 'Manually' : 'Automatically'}</p>
                        ${template.template_type && template.template_type !== 'single_worksheet' ?
                            '<p><strong>Multi-Worksheet:</strong> ✅ Enhanced cross-worksheet analysis available</p>' : ''}
                    </div>
                </div>
                ${worksheetMappingHtml}
                ${validationHtml}
            `;

            const modal = new bootstrap.Modal(document.getElementById('templateDetailsModal'));
            modal.show();
        }

        function displayTemplateDetails(template, validation) {
            const content = document.getElementById('templateDetailsContent');

            let validationHtml = '';
            if (validation) {
                validationHtml = `
                    <div class="card mb-3">
                        <div class="card-header">
                            <i class="fas fa-check-circle"></i> Data Validation
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <strong>Status:</strong>
                                <span class="badge ${validation.is_valid ? 'bg-success' : 'bg-warning'}">
                                    ${validation.is_valid ? 'Valid' : 'Issues Found'}
                                </span>
                            </div>
                            ${validation.warnings && validation.warnings.length > 0 ? `
                                <div class="mb-2">
                                    <strong>Warnings:</strong>
                                    <ul class="mb-0">
                                        ${validation.warnings.map(w => `<li>${w}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${validation.errors && validation.errors.length > 0 ? `
                                <div class="mb-2">
                                    <strong>Errors:</strong>
                                    <ul class="mb-0">
                                        ${validation.errors.map(e => `<li class="text-danger">${e}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-info"></i> Template Information
                    </div>
                    <div class="card-body">
                        <h6>${template.name}</h6>
                        <p><strong>Domain:</strong> ${template.domain}</p>
                        <p><strong>Version:</strong> ${template.version}</p>
                        <p><strong>Description:</strong> ${template.description}</p>
                        <p><strong>Applied:</strong> ${template.manually_applied ? 'Manually' : 'Automatically'}</p>
                    </div>
                </div>
                ${validationHtml}
            `;

            const modal = new bootstrap.Modal(document.getElementById('templateDetailsModal'));
            modal.show();
        }

        function removeTemplate() {
            if (!confirm('Are you sure you want to remove the current template? This will disable enhanced analysis features.')) {
                return;
            }

            fetch('/api/templates/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideTemplateInfo();
                    addMessage('ai', `✅ ${data.message}`);
                } else {
                    addMessage('ai', `❌ Error removing template: ${data.error}`, true);
                }
            })
            .catch(error => {
                console.error('Error removing template:', error);
                addMessage('ai', '❌ Error removing template', true);
            });
        }

        function showTemplateSuggestions() {
            const modal = new bootstrap.Modal(document.getElementById('templateSuggestionsModal'));

            // Use the grouped suggestions if available, otherwise fall back to simple list
            const suggestions = window.currentTemplateSuggestions || templateSuggestions;
            const grouped = window.groupedTemplateSuggestions;

            let suggestionsHtml = '';

            if (grouped && (grouped.multiWorksheet.length > 0 || grouped.singleWorksheet.length > 0)) {
                // Enhanced display with grouping
                if (grouped.multiWorksheet.length > 0) {
                    suggestionsHtml += `
                        <div class="mb-3">
                            <h6><i class="fas fa-layer-group"></i> Multi-Worksheet Templates</h6>
                            ${grouped.multiWorksheet.map(suggestion => `
                                <div class="card mb-2 template-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">${suggestion.name} <span class="badge bg-info">🔗 Multi-Sheet</span></h6>
                                                <small class="text-muted">Match Score: ${(suggestion.score * 100).toFixed(1)}%</small>
                                            </div>
                                            <button class="btn btn-sm btn-primary" onclick="applyTemplateByName('${suggestion.name}')">
                                                Apply Template
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                if (grouped.singleWorksheet.length > 0) {
                    suggestionsHtml += `
                        <div class="mb-3">
                            <h6><i class="fas fa-file"></i> Single-Worksheet Templates</h6>
                            ${grouped.singleWorksheet.map(suggestion => `
                                <div class="card mb-2 template-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1">${suggestion.name}</h6>
                                                <small class="text-muted">Match Score: ${(suggestion.score * 100).toFixed(1)}%</small>
                                            </div>
                                            <button class="btn btn-sm btn-primary" onclick="applyTemplateByName('${suggestion.name}')">
                                                Apply Template
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } else {
                // Fallback to simple display
                suggestionsHtml = suggestions.map(suggestion => `
                    <div class="card mb-2 template-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${suggestion.name}</h6>
                                    <small class="text-muted">Match Score: ${(suggestion.score * 100).toFixed(1)}%</small>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="applyTemplateByName('${suggestion.name}')">
                                    Apply Template
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Populate suggestions
            const suggestionsList = document.getElementById('templateSuggestionsList');
            suggestionsList.innerHTML = suggestionsHtml;

            modal.show();
        }

        function applyTemplateByName(templateName) {
            // This is a simplified version - you'll need to implement proper template ID lookup
            // For now, we'll use a basic name-to-ID conversion
            const templateId = templateName.toLowerCase().replace(/\s+/g, '_') + '_v1';
            applyTemplate(templateId);
        }

        function applyTemplate(templateId) {
            fetch('/api/templates/apply', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    template_id: templateId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showTemplateInfo(data.template);
                    addMessage('ai', `✅ ${data.message}`);

                    // Close modals
                    bootstrap.Modal.getInstance(document.getElementById('templateSuggestionsModal'))?.hide();
                    bootstrap.Modal.getInstance(document.getElementById('allTemplatesModal'))?.hide();
                } else {
                    addMessage('ai', `❌ Error applying template: ${data.error}`, true);
                }
            })
            .catch(error => {
                console.error('Error applying template:', error);
                addMessage('ai', '❌ Error applying template', true);
            });
        }

        function browseTemplates() {
            fetch('/api/templates')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayAllTemplates(data.templates);
                    }
                })
                .catch(error => {
                    console.error('Error fetching templates:', error);
                });
        }

        function displayAllTemplates(templates) {
            const templatesList = document.getElementById('allTemplatesList');

            templatesList.innerHTML = templates.map(template => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 template-card">
                        <div class="card-header">
                            <h6 class="mb-0">${template.name}</h6>
                            <small class="text-muted">${template.domain}</small>
                        </div>
                        <div class="card-body">
                            <p class="card-text">${template.description}</p>
                            <small class="text-muted">Version: ${template.version}</small>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-sm btn-primary w-100" onclick="applyTemplate('${template.id}')">
                                Apply Template
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            const modal = new bootstrap.Modal(document.getElementById('allTemplatesModal'));
            modal.show();
        }

        // Enhanced template info display (replace existing showTemplateInfo)
        function showTemplateInfo(template) {
            currentTemplate = template;

            document.getElementById('templateName').textContent = template.name;

            // Enhanced domain display for multi-worksheet templates
            let domainText = `Domain: ${template.domain}`;
            if (template.multi_worksheet) {
                domainText += ` (Multi-Worksheet)`;
            }
            if (template.type) {
                domainText += ` | Type: ${template.type}`;
            }

            document.getElementById('templateDomain').textContent = domainText;
            document.getElementById('templateInfoContainer').style.display = 'block';

            // Add template indicator to file info if visible
            const fileInfo = document.getElementById('fileInfo');
            if (!fileInfo.classList.contains('hidden')) {
                fileInfo.classList.add('template-indicator');
            }

            // Add multi-worksheet indicator if applicable
            if (template.multi_worksheet) {
                const container = document.getElementById('templateInfoContainer');
                const indicator = container.querySelector('.multi-worksheet-indicator');
                if (!indicator) {
                    const badge = document.createElement('div');
                    badge.className = 'multi-worksheet-indicator';
                    badge.innerHTML = '<small style="background: #005EEF; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px;">🔗 Multi-Sheet</small>';
                    container.appendChild(badge);
                }
            }
        }


        function hideTemplateInfo() {
            currentTemplate = null;
            document.getElementById('templateInfoContainer').style.display = 'none';

            // Remove template indicator
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.classList.remove('template-indicator');
        }


        // Enhanced template suggestion display for multi-worksheet - now integrated in header
        function showTemplateSuggestionsSection(suggestions) {
            templateSuggestions = suggestions;

            if (suggestions.length > 0) {
                // Show template suggestions button in header instead of separate bar
                templateSuggestionsBtn.classList.remove('hidden');
                suggestionsCount.textContent = suggestions.length;

                // Store the suggestion details for the modal
                window.currentTemplateSuggestions = suggestions;

                // Hide the old template suggestions bar
                const oldTemplateSuggestions = document.getElementById('templateSuggestions');
                if (oldTemplateSuggestions) {
                    oldTemplateSuggestions.classList.add('hidden', 'header-integrated');
                }

                // Group suggestions by type for better display in modal (when clicked)
                const multiWorksheetSuggestions = suggestions.filter(s => s.type === 'multi_worksheet' || s.type === 'csv_collection');
                const singleWorksheetSuggestions = suggestions.filter(s => !s.type || s.type === 'single_worksheet');

                // Store grouped suggestions for modal display
                window.groupedTemplateSuggestions = {
                    multiWorksheet: multiWorksheetSuggestions,
                    singleWorksheet: singleWorksheetSuggestions
                };
            }
        }

        function hideTemplateSuggestionsSection() {
            document.getElementById('templateSuggestions').classList.add('hidden');
            templateSuggestions = [];
        }

        function loadCurrentTemplateStatus() {
            fetch('/api/templates/current')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.template) {
                        showTemplateInfo(data.template);
                    }
                })
                .catch(error => {
                    console.debug('No current template or error loading:', error);
                });
        }

        // Enhanced template processing function (replace existing processTemplateInfoFromUpload)
        function processTemplateInfoFromUpload(data) {
            // Handle template information in upload response
            if (data.template_info) {
                if (data.template_info.detected) {
                    // Template was automatically detected
                    const template = {
                        name: data.template_info.template_name,
                        domain: data.template_info.template_domain,
                        type: data.template_info.template_type,
                        multi_worksheet: data.template_info.multi_worksheet_template
                    };

                    showTemplateInfo(template);

                    // Show enhanced success message for multi-worksheet templates
                    if (data.template_info.multi_worksheet_template) {
                        let worksheetInfo = '';
                        if (data.template_info.worksheet_mapping) {
                            const mappings = data.template_info.worksheet_mapping;
                            const matchedSheets = mappings.filter(m => m.matched_worksheet).length;
                            const totalSheets = mappings.length;
                            worksheetInfo = `\n🎯 Template Analysis: Matched ${matchedSheets}/${totalSheets} expected worksheets for enhanced analysis.`;

                            // Show detailed mapping info
                            console.log('Worksheet Template Mapping:', mappings);
                        }

                        addMessage('ai',
                            `✅ Multi-worksheet template "${data.template_info.template_name}" detected! ` +
                            `This will provide enhanced analysis capabilities across your worksheets.${worksheetInfo}`
                        );
                    }

                    // Show validation results if there are issues
                    if (data.template_info.validation_results && !data.template_info.validation_results.is_valid) {
                        console.warn('Template validation issues:', data.template_info.validation_results);

                        // Show summary of validation issues
                        if (data.template_info.validation_results.summary) {
                            const summary = data.template_info.validation_results.summary;
                            if (summary.match_percentage < 100) {
                                addMessage('ai',
                                    `⚠️ Template partially matched (${summary.match_percentage.toFixed(1)}% match). ` +
                                    `Some worksheets may not fully align with the template structure. You can still use enhanced analysis features.`
                                );
                            }
                        }
                    }

                    // Log successful template detection
                    console.log('Multi-worksheet template detected:', data.template_info.template_name, data.template_info);

                } else if (data.template_info.suggestions && data.template_info.suggestions.length > 0) {
                    // Show template suggestions
                    showTemplateSuggestionsSection(data.template_info.suggestions);
                    console.log('Template suggestions available:', data.template_info.suggestions.length);
                }
            }
        }

        // ADD template type indicators to various UI elements
        function addTemplateTypeIndicators() {
            const updateIndicators = () => {
                const isMultiWorksheet = currentTemplate && currentTemplate.multi_worksheet;

                const queryInput = document.getElementById('queryInput');
                if (queryInput && isMultiWorksheet) {
                    queryInput.placeholder = "Ask about your data across worksheets... (e.g., 'Compare sales across all sheets')";
                } else if (queryInput) {
                    queryInput.placeholder = "Ask about your data... (e.g., 'Show correlation matrix')";
                }

                const aiMessages = document.querySelectorAll('.ai-message');
                if (isMultiWorksheet && aiMessages.length > 0) {
                    const lastMessage = aiMessages[aiMessages.length - 1];
                    if (lastMessage && !lastMessage.querySelector('.template-enhanced-indicator')) {
                        lastMessage.classList.add('template-enhanced-message');
                    }
                }
            };

            updateIndicators();
            window.updateTemplateIndicators = updateIndicators;
        }

        // END TEMPLATE MANAGEMENT FUNCTIONS

        // Initialize template functionality when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize template indicators
            addTemplateTypeIndicators();

            // Enhance existing template functions
            if (typeof showTemplateInfo === 'function') {
                const originalShow = showTemplateInfo;
                showTemplateInfo = function(template) {
                    originalShow(template);
                    if (window.updateTemplateIndicators) window.updateTemplateIndicators();
                };
            }

            if (typeof hideTemplateInfo === 'function') {
                const originalHide = hideTemplateInfo;
                hideTemplateInfo = function() {
                    originalHide();
                    if (window.updateTemplateIndicators) window.updateTemplateIndicators();
                };
            }

            // Load current template status if data is already loaded
            if (currentFile) {
                loadCurrentTemplateStatus();
            }

            // Check for shared chart
            const urlParams = new URLSearchParams(window.location.search);
            const chartId = urlParams.get('chart');

            if (chartId) {
                const chartData = sessionStorage.getItem(chartId);
                if (chartData) {
                    const { query, plotData, timestamp } = JSON.parse(chartData);

                    // Create a modal or full-screen view for the shared chart
                    const sharedChartModal = document.createElement('div');
                    sharedChartModal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    `;

                    sharedChartModal.innerHTML = `
                        <div style="background: white; padding: 20px; border-radius: 10px; width: 90%; height: 90%; position: relative;">
                            <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: #ff5555; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer;">
                                Close
                            </button>
                            <h2>${query}</h2>
                            <div id="shared_chart" style="width: 100%; height: calc(100% - 60px);"></div>
                        </div>
                    `;

                    document.body.appendChild(sharedChartModal);

                    // Render the chart
                    Plotly.newPlot('shared_chart', plotData.data, plotData.layout || {}, {responsive: true});
                }
            }
        });

        // Global error recovery - ESC key to reset all stuck states
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && e.shiftKey) {
                // Shift + ESC: Emergency reset all cards
                console.log('Emergency reset triggered');

                document.body.style.cursor = '';
                document.body.style.userSelect = '';

                activeOutputs.forEach((output, outputId) => {
                    emergencyRecoverCard(outputId);
                });

                // Remove any lingering event listeners
                const newBody = document.body.cloneNode(true);
                document.body.parentNode.replaceChild(newBody, document.body);

                addMessage('ai', '🔧 Emergency recovery applied to all output cards');
            }
        });

        // Global cursor cleanup on window events
        window.addEventListener('focus', function() {
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        });

        window.addEventListener('blur', function() {
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        });

        // View Management Variables
        let currentView = 'spreadsheet'; // 'spreadsheet' or 'outputs'
        let stackedOutputs = new Map(); // Store stacked outputs separately

        // Toggle between spreadsheet and outputs view
        function toggleView() {
            const viewToggle = document.getElementById('viewToggle');
            const onlyofficeContainer = document.getElementById('onlyofficeContainer');
            const outputsViewContainer = document.getElementById('outputsViewContainer');
            const currentViewLabel = document.getElementById('currentViewLabel');
            const contentArea = document.getElementById('contentArea');
            const chartsContainer = document.getElementById('chartsContainer');

            if (viewToggle.checked) {
                // Switch to outputs view
                currentView = 'outputs';
                onlyofficeContainer.style.display = 'none';
                outputsViewContainer.classList.add('active');
                currentViewLabel.textContent = 'Output View';
                contentArea.classList.add('outputs-view-active');

                // Explicitly hide all floating output cards
                hideAllFloatingCards();

                // Update outputs view content
                updateOutputsView();

            } else {
                // Switch to spreadsheet view
                currentView = 'spreadsheet';
                onlyofficeContainer.style.display = 'flex';
                outputsViewContainer.classList.remove('active');
                currentViewLabel.textContent = 'Data View';
                contentArea.classList.remove('outputs-view-active');

                // Explicitly show all floating output cards
                showAllFloatingCards();
            }

            // Update button states and visibility
            updateViewDependentControls();
        }

        // Update controls based on current view
        function updateViewDependentControls() {
            const saveBtn = document.getElementById('saveDocument');
            const downloadBtn = document.getElementById('downloadExcel');
            const fullScreenBtn = document.getElementById('viewModeToggle');

            if (currentView === 'outputs') {
                // Hide spreadsheet-specific controls
                saveBtn.style.display = 'none';
                fullScreenBtn.style.display = 'none';
                // Keep download button as it can work for both views
            } else {
                // Show all controls for spreadsheet view
                saveBtn.style.display = 'block';
                fullScreenBtn.style.display = 'block';
            }
        }

        // Update the outputs view content
        function updateOutputsView() {
            const outputsViewContent = document.getElementById('outputsViewContent');
            const outputsViewEmpty = document.getElementById('outputsViewEmpty');

            // Clear existing content
            outputsViewContent.innerHTML = '';

            if (activeOutputs.size === 0) {
                // Show empty state
                outputsViewContent.appendChild(outputsViewEmpty);
            } else {
                // Create stacked cards for each output
                const sortedOutputs = Array.from(activeOutputs.entries())
                    .sort(([,a], [,b]) => new Date(b.timestamp) - new Date(a.timestamp)); // Most recent first

                sortedOutputs.forEach(([outputId, output]) => {
                    const stackedCard = createStackedOutputCard(outputId, output);
                    outputsViewContent.appendChild(stackedCard);
                });
            }
        }

        // Create a stacked version of an output card
        function createStackedOutputCard(outputId, output) {
            const stackedCard = document.createElement('div');
            stackedCard.className = 'stacked-output-card';
            stackedCard.id = `stacked_${outputId}`;

            const truncatedQuery = output.query.length > 80 ? output.query.substring(0, 80) + '...' : output.query;
            const timestamp = new Date(output.timestamp).toLocaleString();

            stackedCard.innerHTML = `
                <div class="stacked-output-header">
                    <div>
                        <div style="font-size: 16px; margin-bottom: 4px;">
                            <i class="fas fa-chart-line"></i> ${truncatedQuery}
                        </div>
                        <div style="font-size: 12px; opacity: 0.8;">
                            <i class="fas fa-clock"></i> ${timestamp}
                        </div>
                    </div>
                    <div class="stacked-output-controls">
                        <button class="stacked-output-btn" onclick="copyStackedOutput('${outputId}')" title="Copy">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="stacked-output-btn" onclick="expandStackedOutput('${outputId}')" title="View in Floating Card">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                        <button class="stacked-output-btn danger" onclick="removeStackedOutput('${outputId}')" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="stacked-output-content">
                    ${formatOutputForDisplay(output.data)}
                </div>
            `;

            // Ensure charts render properly in stacked view
            setTimeout(() => {
                const chartDiv = stackedCard.querySelector('[id^="chart_"]');
                if (chartDiv && typeof Plotly !== 'undefined' && Plotly.Plots) {
                    try {
                        Plotly.Plots.resize(chartDiv);
                    } catch (error) {
                        console.log('Chart resize warning:', error);
                    }
                }
            }, 500);

            return stackedCard;
        }

        // Copy content from stacked output
        function copyStackedOutput(outputId) {
            const output = activeOutputs.get(outputId);
            if (!output) return;

            const content = JSON.stringify(output.data.result, null, 2);

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(content).then(() => {
                    showCopyNotification();
                });
            } else {
                fallbackCopy(content);
            }
        }

        // Expand stacked output to floating card
        function expandStackedOutput(outputId) {
            const output = activeOutputs.get(outputId);
            if (!output) return;

            // Switch back to spreadsheet view
            const viewToggle = document.getElementById('viewToggle');
            viewToggle.checked = false;
            toggleView();

            // Focus the existing floating card
            setTimeout(() => {
                focusOutputCard(outputId);
            }, 300);
        }

        // Remove output from stacked view
        function removeStackedOutput(outputId) {
            closeOutputCard(outputId);
        }

        // Clear all stacked outputs
        function clearAllStackedOutputs() {
            clearAllOutputCards();
        }

        // Initialize view on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure we start in spreadsheet view
            currentView = 'spreadsheet';
            updateViewDependentControls();
        });

        // Hide all floating output cards
        function hideAllFloatingCards() {
            // Hide all output cards
            document.querySelectorAll('.output-card').forEach(card => {
                card.style.display = 'none';
            });

            // Hide the charts container
            const chartsContainer = document.getElementById('chartsContainer');
            if (chartsContainer) {
                chartsContainer.style.display = 'none';
            }
        }

        // Show all floating output cards
        function showAllFloatingCards() {
            // Show all output cards
            document.querySelectorAll('.output-card').forEach(card => {
                card.style.display = 'block';
            });

            // Show the charts container
            const chartsContainer = document.getElementById('chartsContainer');
            if (chartsContainer) {
                chartsContainer.style.display = 'block';
            }
        }

        // Enhanced createOutputCard function to handle view state
        // Add this code to your existing createOutputCard function (after the floating card is created)
        function createOutputCard(data, query) {
            outputCounter++;
            const outputId = data.output_id || `output_${outputCounter}`;

            // Calculate position for new card
            const position = calculateOutputPosition();

            // Create output card
            const outputCard = document.createElement('div');
            outputCard.className = 'output-card new';
            outputCard.id = outputId;
            outputCard.style.left = position.x + 'px';
            outputCard.style.top = position.y + 'px';
            outputCard.style.width = '700px';
            outputCard.style.height = '500px';

            const truncatedQuery = query.length > 50 ? query.substring(0, 50) + '...' : query;
            const timestamp = new Date(data.timestamp).toLocaleTimeString();

            outputCard.innerHTML = `
                <div class="output-card-header">
                    <div class="output-card-title">
                        <i class="fas fa-chart-line"></i> ${truncatedQuery}
                    </div>
                    <div class="output-card-controls">
                        <button class="output-card-btn copy-btn" onclick="showCopyMenu(event, '${outputId}')" title="Copy">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="output-card-btn" onclick="minimizeOutputCard('${outputId}')" title="Minimize">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="output-card-btn" onclick="maximizeOutputCard('${outputId}')" title="Maximize">
                            <i class="fas fa-expand"></i>
                        </button>
                        <button class="output-card-btn danger" onclick="closeOutputCard('${outputId}')" title="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="output-card-content">
                    ${formatOutputForDisplay(data)}
                </div>
                <div class="resize-handle" onmousedown="startResize(event, '${outputId}')"></div>
            `;

            document.body.appendChild(outputCard);

            // Make draggable
            enableOutputCardDrag(outputCard);

            // if stuck
            addEmergencyRecovery(outputCard);

            // Store output data
            activeOutputs.set(outputId, {
                element: outputCard,
                data: data,
                query: query,
                timestamp: data.timestamp,
                minimized: false
            });

            // Add to outputs list
            addToOutputsList(outputId, query, timestamp);

            // Update counter
            updateOutputCount();

            // Focus the card
            focusOutputCard(outputId);

            // Remove 'new' class after animation
            setTimeout(() => {
                outputCard.classList.remove('new');
            }, 300);

            // IMPORTANT: Hide the card if we're currently in outputs view
            if (currentView === 'outputs') {
                outputCard.style.display = 'none';
                updateOutputsView();
            }

            return outputId;
        }

        // function to handle copy menu for data sections
        function showDataCopyMenu(event, combinedId) {
            event.stopPropagation();

            // Remove existing copy menus
            document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());

            const copyMenu = document.createElement('div');
            copyMenu.className = 'copy-menu';
            copyMenu.style.left = event.pageX + 'px';
            copyMenu.style.top = event.pageY + 'px';

            copyMenu.innerHTML = `
                <div class="copy-menu-item" onclick="copyDataContent('${combinedId}', 'text')">
                    <i class="fas fa-align-left"></i> Copy as Text
                </div>
                <div class="copy-menu-item" onclick="copyDataContent('${combinedId}', 'table')">
                    <i class="fas fa-table"></i> Copy as Table
                </div>
                <div class="copy-menu-item" onclick="copyDataContent('${combinedId}', 'json')">
                    <i class="fas fa-code"></i> Copy as JSON
                </div>
                <div class="copy-menu-item" onclick="copyDataContent('${combinedId}', 'csv')">
                    <i class="fas fa-file-csv"></i> Copy as CSV
                </div>
            `;

            document.body.appendChild(copyMenu);

            // Position menu to stay within viewport
            const rect = copyMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                copyMenu.style.left = (event.pageX - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                copyMenu.style.top = (event.pageY - rect.height) + 'px';
            }
        }

        // Add this function to handle copying data content
        function copyDataContent(combinedId, format) {
            const dataContent = document.getElementById(`data_content_${combinedId}`);
            if (!dataContent) {
                console.error('Data content not found for ID:', combinedId);
                return;
            }

            let copyText = '';

            try {
                switch (format) {
                    case 'text':
                        // Get all text content including nested sections
                        copyText = dataContent.textContent || dataContent.innerText || '';
                        break;

                    case 'table':
                        const tables = dataContent.querySelectorAll('.output-table, .nested-table');
                        if (tables.length > 0) {
                            copyText = Array.from(tables).map(table => tableToTSV(table)).join('\n\n');
                        } else {
                            copyText = dataContent.textContent || dataContent.innerText || '';
                        }
                        break;

                    case 'json':
                        // Try to extract structured data from the content
                        const structuredData = extractStructuredDataFromContent(dataContent);
                        copyText = JSON.stringify(structuredData, null, 2);
                        break;

                    case 'csv':
                        const csvTables = dataContent.querySelectorAll('.output-table, .nested-table');
                        if (csvTables.length > 0) {
                            copyText = Array.from(csvTables).map(table => tableToCSV(table)).join('\n\n');
                        } else {
                            // For non-tabular data, create simple CSV format
                            const textContent = dataContent.textContent || dataContent.innerText || '';
                            const lines = textContent.split('\n').filter(line => line.trim());
                            copyText = lines.map(line => `"${line.replace(/"/g, '""')}"`).join('\n');
                        }
                        break;

                    default:
                        copyText = dataContent.textContent || dataContent.innerText || '';
                }

                // Enhanced copy functionality with better error handling
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(copyText).then(() => {
                        showCopyNotification('Data copied to clipboard!');
                        document.querySelectorAll('.copy-menu').forEach(menu => menu.remove());
                    }).catch(err => {
                        console.warn('Clipboard API failed, using fallback:', err);
                        fallbackCopy(copyText);
                    });
                } else {
                    // Fallback for older browsers
                    fallbackCopy(copyText);
                }

            } catch (error) {
                console.error('Error copying data content:', error);
                // Still try to copy something
                fallbackCopy(dataContent.textContent || dataContent.innerText || 'Error copying content');
            }
        }

        // Helper function to extract structured data from DOM content
        function extractStructuredDataFromContent(contentElement) {
            const data = {};

            // Extract data from nested dictionaries
            const dictSections = contentElement.querySelectorAll('.dictionary-section');
            dictSections.forEach(section => {
                const header = section.querySelector('.dictionary-section-header strong');
                const content = section.querySelector('.dictionary-section-content');

                if (header && content) {
                    const key = header.textContent.trim();

                    // Try to extract tables first
                    const tables = content.querySelectorAll('.output-table, .nested-table');
                    if (tables.length > 0) {
                        data[key] = extractTableData(tables[0]);
                    } else {
                        data[key] = content.textContent.trim();
                    }
                }
            });

            // Extract data from simple items
            const simpleItems = contentElement.querySelectorAll('.dictionary-simple-item');
            simpleItems.forEach(item => {
                const text = item.textContent.trim();
                const colonIndex = text.indexOf(':');
                if (colonIndex > 0) {
                    const key = text.substring(0, colonIndex).trim();
                    const value = text.substring(colonIndex + 1).trim();
                    data[key] = value;
                }
            });

            // Extract table data if present
            const mainTables = contentElement.querySelectorAll('.output-table:not(.nested-table)');
            if (mainTables.length > 0) {
                data.table_data = extractTableData(mainTables[0]);
            }

            return Object.keys(data).length > 0 ? data : contentElement.textContent.trim();
        }

        // Helper function to extract data from tables
        function extractTableData(table) {
            const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr')).map(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                if (headers.length > 0) {
                    const rowData = {};
                    headers.forEach((header, index) => {
                        rowData[header] = cells[index] || '';
                    });
                    return rowData;
                }
                return cells;
            });
            return rows;
        }
    </script>
</body>
</html>